<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Unique Team">
        <link rel="canonical" href="https://unique-ag.github.io/ai/unique-toolkit/1.45.9/tutorials/agentic_table_app/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Agentic Table App - Unique Toolkit</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <link href="../../assets/_mkdocstrings.css" rel="stylesheet">
        <link href="../../css/version-select.css" rel="stylesheet">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Unique Toolkit</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="nav-item">
                                <a href="../../architectural/" class="nav-link">Architecture</a>
                            </li>
                            <li class="nav-item">
                                <a href="../../setup/getting_started/" class="nav-link">Getting started</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Authentication</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../authentication/#1-personal-api-key" class="dropdown-item">Personal API Key</a>
</li>
                                    
<li>
    <a href="../../authentication/#2-creating-an-app" class="dropdown-item">Creating an APP</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Application Development</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../application_types/standalone_application/" class="dropdown-item">Standalone Application</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Event Driven Applications</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../application_types/event_driven/" class="dropdown-item">Event Driven App</a>
</li>
            
<li>
    <a href="../../application_types/event_driven/event_driven_platform_setup/" class="dropdown-item">Platform Setup</a>
</li>
            
<li>
    <a href="../../application_types/event_driven/event_driven_with_sse/" class="dropdown-item">SSE Setup</a>
</li>
            
<li>
    <a href="../../application_types/event_driven/event_driven_as_app_with_ngrok/" class="dropdown-item">Web Hooks</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Core Services</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../events/events/" class="dropdown-item">Events</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Chat</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../chat/" class="dropdown-item">Chat Service - Basics</a>
</li>
            
<li>
    <a href="../../chat/advanced_rendering/" class="dropdown-item">Advanced Rendering</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Knowledge Base</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../knowledge_base/" class="dropdown-item">Knowledge Base Service</a>
</li>
            
<li>
    <a href="../../knowledge_base/smart_rules/" class="dropdown-item">Smart Rules</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Agentic Table</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../agentic_table/" class="dropdown-item">Agentic Table Module</a>
</li>
            
<li>
    <a href="../../agentic_table/column_styling/" class="dropdown-item">Column Styling</a>
</li>
            
<li>
    <a href="../../agentic_table/cell_rendering/" class="dropdown-item">Cell rendering</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Examples</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../plattforms/openai/openai/" class="dropdown-item">OpenAI</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Chat</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../modules/examples/chat/chat_service/" class="dropdown-item">Basic Service</a>
</li>
            
<li>
    <a href="../../modules/examples/chat/chat_document_handling/" class="dropdown-item">Document Handling</a>
</li>
            
<li>
    <a href="../../modules/examples/chat/advanced_rendering/" class="dropdown-item">Advanced Rendering</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Knowledge Base</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../modules/examples/content/kb_service/" class="dropdown-item">Base Service</a>
</li>
            
<li>
    <a href="../../modules/examples/content/smart_rules/" class="dropdown-item">Smart Rules</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Tutorials</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">Agentic Table App</a>
</li>
                                    
<li>
    <a href="../file_creation_and_upload_to_chat/" class="dropdown-item">File Creation with Upload to Chat</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Agentic Framework</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../agentic_framework/framework/" class="dropdown-item">Overview</a>
</li>
                                    
<li>
    <a href="../../agentic_framework/orchestrator/unqiue_ai_how-it-works/" class="dropdown-item">Orchestrator</a>
</li>
                                    
<li>
    <a href="../../agentic_framework/tool/" class="dropdown-item">Tool</a>
</li>
                                    
<li>
    <a href="../../agentic_framework/tool_call_response/" class="dropdown-item">Tool Call Response</a>
</li>
                                    
<li>
    <a href="../../agentic_framework/tool_manager/" class="dropdown-item">Tool Manager</a>
</li>
                                    
<li>
    <a href="../../agentic_framework/debug_manager/" class="dropdown-item">Debug Info Manager</a>
</li>
                                    
<li>
    <a href="../../agentic_framework/postprocessor_manager/" class="dropdown-item">Postprocessor Manager</a>
</li>
                                    
<li>
    <a href="../../agentic_framework/evaluation_manager/" class="dropdown-item">Evaluation Manager</a>
</li>
                                    
<li>
    <a href="../../agentic_framework/reference_manager/" class="dropdown-item">Reference Manager</a>
</li>
                                    
<li>
    <a href="../../agentic_framework/history_manager/" class="dropdown-item">History Manager</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">API Reference</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../api/" class="dropdown-item">Overview</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Core Services</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../modules/chat/" class="dropdown-item">Chat Module</a>
</li>
            
<li>
    <a href="../../modules/knowledge_base/" class="dropdown-item">Knowledge Base Module</a>
</li>
            
<li>
    <a href="../../modules/short_term_memory/" class="dropdown-item">Short Term Memory Module</a>
</li>
            
<li>
    <a href="../../modules/app/" class="dropdown-item">App Module</a>
</li>
            
<li>
    <a href="../../modules/content_smart_rules/" class="dropdown-item">Smart Rules</a>
</li>
            
<li>
    <a href="../../modules/data_extraction/" class="dropdown-item">Data Extraction</a>
</li>
            
<li>
    <a href="../../modules/agentic_table/" class="dropdown-item">Agentic Table</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Framework Utilities</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../modules/openai/" class="dropdown-item">OpenAI Client</a>
</li>
            
<li>
    <a href="../../modules/langchain/" class="dropdown-item">Langchain Client</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Deprecated Modules</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../modules/content/" class="dropdown-item">Content Module</a>
</li>
            
<li>
    <a href="../../modules/embedding/" class="dropdown-item">Embedding Module</a>
</li>
            
<li>
    <a href="../../modules/language_model/" class="dropdown-item">Language Model Module</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="nav-item">
                                <a href="../../readme/" class="nav-link">Readme</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../../modules/examples/content/smart_rules/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../file_creation_and_upload_to_chat/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/docs/tutorials/agentic_table_app.md" class="nav-link">Edit on Unique-AG/ai/unique_toolkit
                                    </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#building-an-event-driven-agentic-table-application" class="nav-link">Building an Event-Driven Agentic Table Application</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#what-youll-learn" class="nav-link">What You'll Learn</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#understanding-the-event-flow" class="nav-link">Understanding the Event Flow</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#essential-setup-the-event-handler-and-application" class="nav-link">Essential Setup: The Event Handler and Application</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#defining-your-table-structure" class="nav-link">Defining Your Table Structure</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#implementing-event-handlers" class="nav-link">Implementing Event Handlers</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#framework-utilities-helper-functions" class="nav-link">Framework Utilities: Helper Functions</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#key-concepts" class="nav-link">Key Concepts</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#summary-of-core-capabilities" class="nav-link">Summary of Core Capabilities</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#next-steps" class="nav-link">Next Steps</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="building-an-event-driven-agentic-table-application">Building an Event-Driven Agentic Table Application<a class="headerlink" href="#building-an-event-driven-agentic-table-application" title="Permanent link">&para;</a></h1>
<p>This tutorial shows how to build an Agentic Table application that responds to user interactions through event handlers. An Agentic Table is an interactive spreadsheet component in the Unique platform that can be automated using Python event handlers.</p>
<h2 id="what-youll-learn">What You'll Learn<a class="headerlink" href="#what-youll-learn" title="Permanent link">&para;</a></h2>
<ul>
<li>Understanding the event-driven architecture of Agentic Tables</li>
<li>Setting up a FastAPI application to receive and route table events</li>
<li>Implementing handlers for different table lifecycle events</li>
<li>Using the AgenticTableService to interact with tables programmatically</li>
<li><strong>Working with file metadata</strong> to build intelligent routing logic</li>
<li><strong>Creating clickable references</strong> that link table content to source documents</li>
</ul>
<h2 id="understanding-the-event-flow">Understanding the Event Flow<a class="headerlink" href="#understanding-the-event-flow" title="Permanent link">&para;</a></h2>
<p>Agentic Tables work through an event-driven architecture. When users interact with a table in the Unique platform, events are sent to your webhook server. Here are the main events you'll handle:</p>
<h3 id="table-lifecycle-events">Table Lifecycle Events<a class="headerlink" href="#table-lifecycle-events" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p><strong><code>SHEET_CREATED</code></strong> </p>
<ul>
<li>Triggered when a user creates a new table sheet</li>
<li>Use this to initialize your table structure (headers, column styles)</li>
</ul>
</li>
<li>
<p><strong><code>ADD_META_DATA</code></strong> </p>
<ul>
<li>Triggered when a user adds question files or source files</li>
<li>Use this to process uploaded files and populate table data</li>
<li>Implement custom logic for handling different file types</li>
</ul>
</li>
<li>
<p><strong><code>UPDATE_CELL</code></strong> </p>
<ul>
<li>Triggered when a user edits an editable cell</li>
<li>Use this to implement business rules and automation</li>
<li>React to specific column changes with custom workflows</li>
</ul>
</li>
<li>
<p><strong><code>GENERATE_ARTIFACT</code></strong> </p>
<ul>
<li>Triggered when a user clicks to export -&gt; generate a document</li>
<li>Use this to create exportable reports or documents from table data</li>
</ul>
</li>
<li>
<p><strong><code>SHEET_COMPLETED</code></strong> </p>
<ul>
<li>Triggered when a user marks a sheet as completed</li>
<li>Use this for final validation, archival, or triggering downstream processes</li>
</ul>
</li>
</ol>
<p>Here's how the event flow works:</p>
<pre class="mermaid"><code>sequenceDiagram
    participant User
    participant UniquePlatform
    participant YourWebhook
    participant AgenticTableService

    User-&gt;&gt;UniquePlatform: Interacts with table
    UniquePlatform-&gt;&gt;YourWebhook: Sends event webhook
    YourWebhook-&gt;&gt;UniquePlatform: Register agent (lock table)
    YourWebhook-&gt;&gt;YourWebhook: Route to specific handler
    YourWebhook-&gt;&gt;AgenticTableService: Process event (update cells, status, etc.)
    AgenticTableService-&gt;&gt;UniquePlatform: Apply changes
    YourWebhook-&gt;&gt;UniquePlatform: Deregister agent (unlock table)
    UniquePlatform-&gt;&gt;User: Display updated table</code></pre>
<h2 id="essential-setup-the-event-handler-and-application">Essential Setup: The Event Handler and Application<a class="headerlink" href="#essential-setup-the-event-handler-and-application" title="Permanent link">&para;</a></h2>
<p>Before diving into individual handlers, let's set up the core infrastructure. The main event handler receives all events and routes them to specialized handlers:</p>
<div id="main_event_handler" class="highlight"><span class="filename">#main_event_handler</span><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unique_sdk.api_resources._agentic_table</span><span class="w"> </span><span class="kn">import</span> <span class="n">ActivityStatus</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unique_toolkit.agentic_table.service</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgenticTableService</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unique_toolkit.agentic_table.schemas</span><span class="w"> </span><span class="kn">import</span> <span class="n">MagicTableAction</span><span class="p">,</span> <span class="n">MagicTableEvent</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">agentic_table_event_handler</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n">MagicTableEvent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main event handler that routes table events to specialized handlers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Initialize the service to interact with the table</span>
    <span class="n">at_service</span> <span class="o">=</span> <span class="n">AgenticTableService</span><span class="p">(</span>
        <span class="n">user_id</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
        <span class="n">company_id</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">company_id</span><span class="p">,</span>
        <span class="n">table_id</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">table_id</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Register agent - locks the table during processing</span>
    <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">register_agent</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Route events based on action type</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="n">MagicTableAction</span><span class="o">.</span><span class="n">SHEET_CREATED</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">deregister_agent</span><span class="p">()</span>
            <span class="k">await</span> <span class="n">handle_sheet_created</span><span class="p">(</span><span class="n">at_service</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="n">MagicTableAction</span><span class="o">.</span><span class="n">ADD_META_DATA</span><span class="p">:</span>
            <span class="n">downloader</span> <span class="o">=</span> <span class="n">get_downloader</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">company_id</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">chat_id</span><span class="p">)</span>
            <span class="n">file_content_getter</span> <span class="o">=</span> <span class="n">get_file_content_getter</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">company_id</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">chat_id</span><span class="p">)</span>
            <span class="n">reference_builder</span> <span class="o">=</span> <span class="n">get_augmented_text_with_references</span><span class="p">(</span>
                <span class="n">event</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">company_id</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">chat_id</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">assistant_id</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="n">handle_metadata_added</span><span class="p">(</span>
                <span class="n">at_service</span><span class="p">,</span> 
                <span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="p">,</span> 
                <span class="n">downloader</span><span class="p">,</span>
                <span class="n">file_content_getter</span><span class="p">,</span>
                <span class="n">reference_builder</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="n">MagicTableAction</span><span class="o">.</span><span class="n">UPDATE_CELL</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">handle_cell_updated</span><span class="p">(</span><span class="n">at_service</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="n">MagicTableAction</span><span class="o">.</span><span class="n">GENERATE_ARTIFACT</span><span class="p">:</span>
            <span class="n">uploader</span> <span class="o">=</span> <span class="n">get_uploader</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">company_id</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">chat_id</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">handle_artifact_generated</span><span class="p">(</span><span class="n">at_service</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="p">,</span> <span class="n">uploader</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="n">MagicTableAction</span><span class="o">.</span><span class="n">SHEET_COMPLETED</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sheet completed: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">sheet_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Implement your completion logic here</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">set_activity</span><span class="p">(</span>
                <span class="n">activity</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="n">ActivityStatus</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span>
                <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Unknown action: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown action: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="mi">0</span>  <span class="c1"># Success</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in handler: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">1</span>  <span class="c1"># Failure</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># Always deregister - unlocks the table</span>
        <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">deregister_agent</span><span class="p">()</span>
</code></pre></div>
<p>Now create the FastAPI application and run it:</p>
<div id="create_and_run_app" class="highlight"><span class="filename">#create_and_run_app</span><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unique_toolkit.agentic_table.schemas</span><span class="w"> </span><span class="kn">import</span> <span class="n">MagicTableEventTypes</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unique_toolkit.app.fast_api_factory</span><span class="w"> </span><span class="kn">import</span> <span class="n">build_unique_custom_app</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unique_toolkit.app.unique_settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">UniqueSettings</span>

<span class="c1"># Initialize settings</span>
<span class="n">_SETTINGS</span> <span class="o">=</span> <span class="n">UniqueSettings</span><span class="o">.</span><span class="n">from_env</span><span class="p">(</span><span class="n">env_file</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;unique.env&quot;</span><span class="p">)</span>
<span class="n">_SETTINGS</span><span class="o">.</span><span class="n">init_sdk</span><span class="p">()</span>

<span class="c1"># Create app with the event handler</span>
<span class="n">_MINIMAL_APP</span> <span class="o">=</span> <span class="n">build_unique_custom_app</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Unique Minimal Agentic Table App&quot;</span><span class="p">,</span>
    <span class="n">settings</span><span class="o">=</span><span class="n">_SETTINGS</span><span class="p">,</span>
    <span class="n">event_handler</span><span class="o">=</span><span class="n">agentic_table_event_handler</span><span class="p">,</span>
    <span class="n">event_constructor</span><span class="o">=</span><span class="n">MagicTableEvent</span><span class="p">,</span>
    <span class="n">subscribed_event_names</span><span class="o">=</span><span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">MagicTableEventTypes</span><span class="p">],</span>
<span class="p">)</span>

<span class="c1"># Run the application</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">uvicorn</span>

    <span class="n">uvicorn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="s2">&quot;fastapi_app_agentic_table:_MINIMAL_APP&quot;</span><span class="p">,</span>
        <span class="n">host</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span>
        <span class="n">port</span><span class="o">=</span><span class="mi">5001</span><span class="p">,</span>
        <span class="n">reload</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">log_level</span><span class="o">=</span><span class="s2">&quot;debug&quot;</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
<p>Run with: <code>python fastapi_app_agentic_table.py</code></p>
<h2 id="defining-your-table-structure">Defining Your Table Structure<a class="headerlink" href="#defining-your-table-structure" title="Permanent link">&para;</a></h2>
<p>Before implementing the handlers, we need to define what our table looks like. This example demonstrates a configuration pattern for defining columns. While this is hardcoded here, you can easily initialize it from a configuration payload, database, or user settings.</p>
<p>The column definitions specify:</p>
<ul>
<li><strong>Order</strong>: Position of the column (0-indexed)</li>
<li><strong>Name</strong>: Column header text</li>
<li><strong>Width</strong>: Column width in pixels</li>
<li><strong>Renderer</strong>: Type of cell renderer (dropdown, checkbox, collaborator selector, etc.)</li>
<li><strong>Editable</strong>: Whether users can edit the column</li>
</ul>
<details class="example">
<summary>Column Definition Example (Click to expand)</summary>
<div class="tabbed-set tabbed-alternate" data-tabs="1:1"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">Column Definitions</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">StrEnum</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unique_sdk</span><span class="w"> </span><span class="kn">import</span> <span class="n">CellRendererTypes</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ExampleColumnNames</span><span class="p">(</span><span class="n">StrEnum</span><span class="p">):</span>
    <span class="n">QUESTION</span> <span class="o">=</span> <span class="s2">&quot;Question&quot;</span>
    <span class="n">SECTION</span> <span class="o">=</span> <span class="s2">&quot;Section&quot;</span>
    <span class="n">ANSWER</span> <span class="o">=</span> <span class="s2">&quot;Answer&quot;</span>
    <span class="n">CRITICAL_CONSISTENCY</span> <span class="o">=</span> <span class="s2">&quot;Critical Consistency&quot;</span>
    <span class="n">STATUS</span> <span class="o">=</span> <span class="s2">&quot;Status&quot;</span>
    <span class="n">REVIEWER</span> <span class="o">=</span> <span class="s2">&quot;Reviewer&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ColumnDefinition</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Defines a single table column&#39;s structure and styling.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        order: Column position (0-indexed)</span>
<span class="sd">        name: Column header text</span>
<span class="sd">        width: Column width in pixels</span>
<span class="sd">        renderer: Optional cell renderer type (dropdown, checkbox, etc.)</span>
<span class="sd">        editable: Whether the column is editable</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">order</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">ExampleColumnNames</span>
    <span class="n">width</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">renderer</span><span class="p">:</span> <span class="n">CellRendererTypes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">editable</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ColumnDefinitions</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Container for all column definitions in the table.</span>

<span class="sd">    Provides helper methods to access columns by name.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ColumnDefinition</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">column_map</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ColumnDefinition</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Map of column names to their definitions.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">column</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">column</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_column_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ColumnDefinition</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get column definition by name.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_map</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_column_name_by_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExampleColumnNames</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get column definition by order.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">order</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_column_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get list of all column names.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>





<span class="n">example_configuration</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;columns&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">ExampleColumnNames</span><span class="o">.</span><span class="n">QUESTION</span><span class="p">,</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
            <span class="s2">&quot;renderer&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;editable&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">ExampleColumnNames</span><span class="o">.</span><span class="n">SECTION</span><span class="p">,</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">150</span><span class="p">,</span>
            <span class="s2">&quot;renderer&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;editable&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">ExampleColumnNames</span><span class="o">.</span><span class="n">ANSWER</span><span class="p">,</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>
            <span class="s2">&quot;renderer&quot;</span><span class="p">:</span> <span class="n">CellRendererTypes</span><span class="o">.</span><span class="n">SELECTABLE_CELL_RENDERER</span><span class="p">,</span>
            <span class="s2">&quot;editable&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">ExampleColumnNames</span><span class="o">.</span><span class="n">CRITICAL_CONSISTENCY</span><span class="p">,</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
            <span class="s2">&quot;renderer&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;editable&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">ExampleColumnNames</span><span class="o">.</span><span class="n">STATUS</span><span class="p">,</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">150</span><span class="p">,</span>
            <span class="s2">&quot;renderer&quot;</span><span class="p">:</span> <span class="n">CellRendererTypes</span><span class="o">.</span><span class="n">REVIEW_STATUS_DROPDOWN</span><span class="p">,</span>
            <span class="s2">&quot;editable&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">ExampleColumnNames</span><span class="o">.</span><span class="n">REVIEWER</span><span class="p">,</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">150</span><span class="p">,</span>
            <span class="s2">&quot;renderer&quot;</span><span class="p">:</span> <span class="n">CellRendererTypes</span><span class="o">.</span><span class="n">COLLABORATOR_DROPDOWN</span><span class="p">,</span>
            <span class="s2">&quot;editable&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">]</span>
<span class="p">}</span>

<span class="n">example_column_definitions</span> <span class="o">=</span> <span class="n">ColumnDefinitions</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span><span class="n">example_configuration</span><span class="p">)</span>
</code></pre></div>
</div>
</div>
</div>
</details>
<p>This creates a typed interface for your table that ensures consistency across all operations. You'll reference these definitions in your handlers to access columns by name.</p>
<h2 id="implementing-event-handlers">Implementing Event Handlers<a class="headerlink" href="#implementing-event-handlers" title="Permanent link">&para;</a></h2>
<p>Now let's implement each handler. Each one uses the <code>AgenticTableService</code> (<code>at_service</code>) to interact with the table.</p>
<h3 id="handler-1-sheet-created-event">Handler 1: Sheet Created Event<a class="headerlink" href="#handler-1-sheet-created-event" title="Permanent link">&para;</a></h3>
<p><strong>When</strong>: Triggered when a user creates a new table sheet.</p>
<p><strong>Goal</strong>: Initialize the table by setting up column headers and applying styling.</p>
<p><strong>What we do with <code>at_service</code></strong>:</p>
<ul>
<li><code>set_activity()</code> - Shows status messages to users (e.g., "Initializing table schema...")</li>
<li><code>set_cell()</code> - Sets individual cell values (used here to write column headers in row 0)</li>
<li><code>set_column_style()</code> - Applies styling to columns (width, renderer type, editability)</li>
</ul>
<p>This handler prepares the empty table structure so it's ready to receive data. After this runs, users will see a properly formatted table with headers and the correct column configurations.</p>
<details class="example">
<summary>Sheet Created Handler Implementation (Click to expand)</summary>
<div class="tabbed-set tabbed-alternate" data-tabs="2:1"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">Sheet Created Handler</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">getLogger</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">unique_sdk.api_resources._agentic_table</span><span class="w"> </span><span class="kn">import</span> <span class="n">ActivityStatus</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">unique_toolkit.agentic_table.schemas</span><span class="w"> </span><span class="kn">import</span> <span class="n">MagicTableSheetCreatedPayload</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unique_toolkit.agentic_table.service</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgenticTableService</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.agentic_table_example_column_definition</span><span class="w"> </span><span class="kn">import</span> <span class="n">example_column_definitions</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_sheet_created</span><span class="p">(</span>
    <span class="n">at_service</span><span class="p">:</span> <span class="n">AgenticTableService</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">MagicTableSheetCreatedPayload</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Example handler for the sheet creation event.</span>

<span class="sd">    This demo shows how to initialize a new table by:</span>
<span class="sd">    - Setting column headers in row 0</span>
<span class="sd">    - Applying column styles (width, renderer type, editability)</span>

<span class="sd">    The table is ready to receive data after initialization.</span>

<span class="sd">    Args:</span>
<span class="sd">        at_service: Service instance for table operations</span>
<span class="sd">        payload: Event payload with table_id and sheet_name</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initializing Source of Wealth table: </span><span class="si">{</span><span class="n">payload</span><span class="o">.</span><span class="n">sheet_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Set activity status</span>
    <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">set_activity</span><span class="p">(</span>
        <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Initializing table schema...&quot;</span><span class="p">,</span>
        <span class="n">activity</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="n">ActivityStatus</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Set headers in row 0</span>
    <span class="k">for</span> <span class="n">col_def</span> <span class="ow">in</span> <span class="n">example_column_definitions</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">set_cell</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="n">col_def</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">col_def</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Set </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">example_column_definitions</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2"> column headers&quot;</span><span class="p">)</span>

    <span class="c1"># Apply column styles</span>
    <span class="k">for</span> <span class="n">col_def</span> <span class="ow">in</span> <span class="n">example_column_definitions</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">set_column_style</span><span class="p">(</span>
            <span class="n">column</span><span class="o">=</span><span class="n">col_def</span><span class="o">.</span><span class="n">order</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="n">col_def</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
            <span class="n">cell_renderer</span><span class="o">=</span><span class="n">col_def</span><span class="o">.</span><span class="n">renderer</span><span class="p">,</span>
            <span class="n">editable</span><span class="o">=</span><span class="n">col_def</span><span class="o">.</span><span class="n">editable</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Applied column styles with all CellRendererTypes&quot;</span><span class="p">)</span>

    <span class="c1"># Set completion status</span>
    <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">set_activity</span><span class="p">(</span>
        <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Table schema initialized successfully&quot;</span><span class="p">,</span>
        <span class="n">activity</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="n">ActivityStatus</span><span class="o">.</span><span class="n">COMPLETED</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
</div>
</div>
</div>
</details>
<h3 id="handler-2-metadata-added-event">Handler 2: Metadata Added Event<a class="headerlink" href="#handler-2-metadata-added-event" title="Permanent link">&para;</a></h3>
<p><strong>When</strong>: Triggered when a user uploads a question file or source file to the table.</p>
<p><strong>Goal</strong>: Process the uploaded file and populate the table with data. This handler demonstrates two powerful framework capabilities:</p>
<ol>
<li><strong>CSV Processing</strong>: Parse question files and batch-populate cells</li>
<li><strong>Content Metadata &amp; References</strong>: Retrieve file metadata and create clickable references</li>
</ol>
<h4 id="part-a-processing-question-files-csv">Part A: Processing Question Files (CSV)<a class="headerlink" href="#part-a-processing-question-files-csv" title="Permanent link">&para;</a></h4>
<p>The first part handles question files by downloading and parsing CSV data:</p>
<p><strong>What we do with <code>at_service</code></strong>:</p>
<ul>
<li><code>set_activity()</code> - Updates users on progress through multiple stages ("Downloading CSV...", "Parsing...", "Populating...")</li>
<li><code>set_multiple_cells()</code> - Batch operation to set many cells at once (much more efficient than individual updates)</li>
</ul>
<p>This showcases how to automate data entry. You could extend this to:</p>
<ul>
<li>Use AI agents to generate answers for questions in the CSV</li>
<li>Validate or enrich data before populating the table</li>
<li>Implement custom parsing logic for different file types</li>
</ul>
<h4 id="part-b-processing-source-files-with-metadata">Part B: Processing Source Files with Metadata<a class="headerlink" href="#part-b-processing-source-files-with-metadata" title="Permanent link">&para;</a></h4>
<p>The second part demonstrates <strong>two core framework capabilities</strong> that are essential for building sophisticated applications:</p>
<h5 id="1-retrieving-file-content-and-metadata">1. Retrieving File Content and Metadata<a class="headerlink" href="#1-retrieving-file-content-and-metadata" title="Permanent link">&para;</a></h5>
<p>When users upload source files, you can retrieve the full <code>Content</code> objects which include:</p>
<ul>
<li><strong>content.id</strong>: Unique identifier</li>
<li><strong>content.metadata</strong>: Custom key-value pairs (e.g., <code>{"section": "Finance", "department": "Legal"}</code>)</li>
<li><strong>content.title</strong>: File name or title</li>
<li><strong>content.text</strong>: Extracted text content</li>
<li><strong>content.chunks</strong>: List of ContentChunk objects for chunked documents</li>
</ul>
<p><strong>Example: Organizing Files by Metadata</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Retrieve Content objects for uploaded files</span>
<span class="n">content</span> <span class="o">=</span> <span class="n">file_content_getter_fn</span><span class="p">(</span><span class="n">file_id</span><span class="p">)</span>

<span class="c1"># Access metadata</span>
<span class="k">if</span> <span class="n">content</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
    <span class="n">section</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;section&quot;</span><span class="p">)</span>
    <span class="n">department</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;department&quot;</span><span class="p">)</span>

<span class="c1"># EXAMPLE: Use ContentRegistry to group files by metadata keys</span>
<span class="c1"># (This is just one approach - implement your own filtering logic!)</span>
<span class="n">content_registry</span> <span class="o">=</span> <span class="n">ContentRegistry</span><span class="p">(</span>
    <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Finance&quot;</span><span class="p">,</span> <span class="s2">&quot;Legal&quot;</span><span class="p">,</span> <span class="s2">&quot;Technical&quot;</span><span class="p">],</span>
    <span class="n">contents</span><span class="o">=</span><span class="n">all_contents</span>
<span class="p">)</span>

<span class="c1"># Retrieve all files with specific metadata key</span>
<span class="n">finance_files</span> <span class="o">=</span> <span class="n">content_registry</span><span class="o">.</span><span class="n">get_contents_by_metadata_key</span><span class="p">(</span><span class="s2">&quot;Finance&quot;</span><span class="p">)</span>

<span class="c1"># Alternative: Implement your own filtering</span>
<span class="n">finance_files</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">all_contents</span> 
    <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;department&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;Finance&quot;</span>
<span class="p">]</span>
</code></pre></div>
<p><strong>Use Cases</strong>:
- Route different source files to different table rows based on categories
- Filter content by department, section, or custom tags
- Build conditional logic based on file properties</p>
<h5 id="2-creating-clickable-references">2. Creating Clickable References<a class="headerlink" href="#2-creating-clickable-references" title="Permanent link">&para;</a></h5>
<p>The framework provides a reference system that converts inline citations into clickable links in the UI. This is crucial when AI agents generate text with citations to source documents.</p>
<p><strong>Why This Matters</strong>:
- Users can click references to view source documents
- Creates audit trails for AI-generated content
- Improves transparency and trust in automated workflows
- Enables verification of information</p>
<p><strong>The Reference Workflow</strong>:</p>
<div class="highlight"><pre><span></span><code>Step 1: AI/Logic generates text with inline citations
  &quot;According to the Q3 report [chunk_abc123], revenue increased [chunk_xyz789].&quot;

Step 2: Create reference registry mapping IDs to Content objects
  {
    &quot;chunk_abc123&quot;: &lt;Content object for Q3 report&gt;,
    &quot;chunk_xyz789&quot;: &lt;Content object for financial data&gt;
  }

Step 3: Convert citations to numbered references
  &quot;According to the Q3 report [1], revenue increased [2].&quot;

Step 4: Frontend renders as clickable links
  &quot;According to the Q3 report [1], revenue increased [2].&quot;
  (clicking [1] opens the Q3 report document)
</code></pre></div>
<p><strong>Implementation Example</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Step 1: Create temporary IDs for your content items</span>
<span class="n">reference_registry</span> <span class="o">=</span> <span class="n">create_id_map</span><span class="p">(</span><span class="n">relevant_contents</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;chunk&quot;</span><span class="p">)</span>
<span class="c1"># Returns: {&quot;chunk_a1b2c3d4&quot;: content1, &quot;chunk_x9y8z7w6&quot;: content2, ...}</span>

<span class="c1"># Step 2: Generate text with inline citations (from AI or your logic)</span>
<span class="n">text_with_citations</span> <span class="o">=</span> <span class="s2">&quot;Based on the analysis [chunk_a1b2c3d4], we conclude...&quot;</span>

<span class="c1"># Step 3: Convert to clickable references</span>
<span class="n">augmented_text</span> <span class="o">=</span> <span class="n">augmented_text_with_references_fn</span><span class="p">(</span>
    <span class="n">text_with_citations</span><span class="p">,</span>
    <span class="n">reference_registry</span><span class="p">,</span>
    <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;chunk&quot;</span><span class="p">,</span>
    <span class="n">citation_pattern</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;\[chunk_([a-zA-Z0-9\-]+)\]&quot;</span>
<span class="p">)</span>
<span class="c1"># Returns: &quot;Based on the analysis [1&amp;message_123], we conclude...&quot;</span>
<span class="c1"># Frontend renders as: &quot;Based on the analysis [1], we conclude...&quot; (clickable)</span>
</code></pre></div>
<p><strong>Use Cases</strong>:
- Link AI-generated answers to source documents
- Create audit trails for compliance and review
- Enable fact-checking and verification workflows
- Build transparent, explainable AI systems
- Track provenance of information across your pipeline</p>
<p><strong>What we do with <code>at_service</code></strong>:</p>
<ul>
<li><code>set_activity()</code> - Provides progress updates during processing</li>
<li><code>get_sheet()</code> - Retrieves table data to understand what's already populated</li>
<li><code>get_num_rows()</code> - Gets the current number of rows</li>
<li><code>set_multiple_cells()</code> - Batch updates cells with referenced content</li>
</ul>
<p>The key takeaway is the batch operation pattern - when dealing with large datasets, always use <code>set_multiple_cells()</code> instead of individual <code>set_cell()</code> calls.</p>
<details class="example">
<summary>Metadata Added Handler Implementation (Click to expand)</summary>
<div class="tabbed-set tabbed-alternate" data-tabs="3:1"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="__tabbed_3_1">Metadata Added Handler</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">getLogger</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unique_sdk.api_resources._agentic_table</span><span class="w"> </span><span class="kn">import</span> <span class="n">ActivityStatus</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">unique_toolkit.agentic_table.schemas</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">MagicTableAddMetadataPayload</span><span class="p">,</span>
    <span class="n">MagicTableCell</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unique_toolkit.agentic_table.service</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgenticTableService</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unique_toolkit.content</span><span class="w"> </span><span class="kn">import</span> <span class="n">Content</span><span class="p">,</span> <span class="n">ContentChunk</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.agentic_table_example_column_definition</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">ExampleColumnNames</span><span class="p">,</span>
    <span class="n">example_column_definitions</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.agentic_table_helper_functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ContentRegistry</span><span class="p">,</span> <span class="n">create_id_map</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_question_files</span><span class="p">(</span>
    <span class="n">at_service</span><span class="p">:</span> <span class="n">AgenticTableService</span><span class="p">,</span>
    <span class="n">payload</span><span class="p">:</span> <span class="n">MagicTableAddMetadataPayload</span><span class="p">,</span>
    <span class="n">downloader_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">bytes</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handle question files by downloading and parsing CSV to populate the table.</span>

<span class="sd">    Args:</span>
<span class="sd">        at_service: Service instance for table operations</span>
<span class="sd">        payload: Event payload with metadata and file IDs</span>
<span class="sd">        downloader_fn: Function to download file contents</span>

<span class="sd">    Returns:</span>
<span class="sd">        Number of rows added to the table</span>

<span class="sd">    Raises:</span>
<span class="sd">        Exception: If CSV processing fails</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check if question files were provided</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">payload</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">question_file_ids</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No question files provided in metadata&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">set_activity</span><span class="p">(</span>
        <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Downloading CSV file...&quot;</span><span class="p">,</span>
        <span class="n">activity</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="n">ActivityStatus</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Get the first question file (CSV)</span>
    <span class="n">file_id</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">question_file_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading file: </span><span class="si">{</span><span class="n">file_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># Download file content</span>
    <span class="n">file_content</span> <span class="o">=</span> <span class="n">downloader_fn</span><span class="p">(</span><span class="n">file_id</span><span class="p">)</span>

    <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">set_activity</span><span class="p">(</span>
        <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Parsing CSV file...&quot;</span><span class="p">,</span>
        <span class="n">activity</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="n">ActivityStatus</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">file_content_stream</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">file_content</span><span class="p">)</span>

    <span class="c1"># Parse CSV file</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_content_stream</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># Convert NA values to empty strings</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parsed CSV with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2"> columns&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>

    <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">set_activity</span><span class="p">(</span>
        <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Populating table with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows...&quot;</span><span class="p">,</span>
        <span class="n">activity</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="n">ActivityStatus</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Create batch cells</span>
    <span class="n">cells</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">row_idx</span><span class="p">,</span> <span class="n">row_data</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">col_def</span> <span class="ow">in</span> <span class="n">example_column_definitions</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">cell_value</span> <span class="o">=</span> <span class="n">row_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">col_def</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cell_value</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">MagicTableCell</span><span class="p">(</span>
                    <span class="n">row_order</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">row_idx</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>
                    <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># +1 for header row</span>
                    <span class="n">column_order</span><span class="o">=</span><span class="n">col_def</span><span class="o">.</span><span class="n">order</span><span class="p">,</span>
                    <span class="n">text</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">cell_value</span><span class="p">),</span>
                    <span class="n">sheet_id</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">table_id</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cells</span><span class="p">)</span><span class="si">}</span><span class="s2"> cells for batch upload&quot;</span><span class="p">)</span>

    <span class="c1"># Batch upload all cells</span>
    <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">set_multiple_cells</span><span class="p">(</span><span class="n">cells</span><span class="o">=</span><span class="n">cells</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully populated table with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_source_files</span><span class="p">(</span>
    <span class="n">at_service</span><span class="p">:</span> <span class="n">AgenticTableService</span><span class="p">,</span>
    <span class="n">payload</span><span class="p">:</span> <span class="n">MagicTableAddMetadataPayload</span><span class="p">,</span>
    <span class="n">file_content_getter_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Content</span> <span class="o">|</span> <span class="kc">None</span><span class="p">],</span>
    <span class="n">augmented_text_with_references_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
        <span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Content</span> <span class="o">|</span> <span class="n">ContentChunk</span><span class="p">],</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">str</span>
    <span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handle source files by retrieving content and organizing by metadata.</span>

<span class="sd">    This handler demonstrates two key framework capabilities:</span>
<span class="sd">    1. Retrieving file content and accessing metadata</span>
<span class="sd">    2. Creating clickable references that link table cells to source documents</span>

<span class="sd">    The example shows:</span>
<span class="sd">    - How to fetch Content objects for uploaded files</span>
<span class="sd">    - How to use ContentRegistry to group files by metadata keys</span>
<span class="sd">    - How to generate text with inline citations and convert them to clickable references</span>
<span class="sd">    - How to populate table cells with referenced content</span>

<span class="sd">    Args:</span>
<span class="sd">        at_service: Service instance for table operations</span>
<span class="sd">        payload: Event payload with metadata and file IDs</span>
<span class="sd">        file_content_getter_fn: Function to retrieve file content objects</span>
<span class="sd">        augmented_text_with_references_fn: Function to convert citations to references</span>

<span class="sd">    Returns:</span>
<span class="sd">        Number of content items processed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check if source files were provided</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">payload</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">source_file_ids</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No source files provided in metadata&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">set_activity</span><span class="p">(</span>
        <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Processing source files metadata...&quot;</span><span class="p">,</span>
        <span class="n">activity</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="n">ActivityStatus</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">cells_to_update</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">MagicTableCell</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">num_rows</span> <span class="o">=</span> <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">get_num_rows</span><span class="p">()</span>

    <span class="c1"># STEP 1: Retrieve Content objects for all source files</span>
    <span class="c1"># Each Content object contains:</span>
    <span class="c1"># - content.id: Unique identifier</span>
    <span class="c1"># - content.metadata: Custom key-value pairs (e.g., {&quot;section&quot;: &quot;Finance&quot;})</span>
    <span class="c1"># - content.title: File name or title</span>
    <span class="c1"># - content.text: Extracted text content</span>
    <span class="c1"># - content.chunks: List of ContentChunk objects for chunked documents</span>
    <span class="n">all_contents</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">file_id</span> <span class="ow">in</span> <span class="n">payload</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">source_file_ids</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">file_content_getter_fn</span><span class="p">(</span><span class="n">file_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No content found for file: </span><span class="si">{</span><span class="n">file_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">content</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No metadata found for file: </span><span class="si">{</span><span class="n">file_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">all_contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

    <span class="c1"># STEP 2: Organize content by metadata keys</span>
    <span class="c1"># This example assumes source files have metadata like:</span>
    <span class="c1"># {&quot;Team&quot;: &quot;true&quot;}, {&quot;Finance&quot;: &quot;true&quot;}, {&quot;Technical&quot;: &quot;true&quot;}, etc.</span>
    <span class="n">sections_of_interest</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;Team&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Finance&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Technical&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Planning&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="c1"># ContentRegistry groups files by metadata keys</span>
    <span class="c1"># You can later retrieve all files tagged with &quot;Finance&quot;, &quot;Team&quot;, etc.</span>
    <span class="n">content_registry</span> <span class="o">=</span> <span class="n">ContentRegistry</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="n">sections_of_interest</span><span class="p">,</span> <span class="n">contents</span><span class="o">=</span><span class="n">all_contents</span><span class="p">)</span>

    <span class="c1"># STEP 3: Process each row in the table</span>
    <span class="c1"># This demonstrates row-by-row processing where each row might need different source files</span>
    <span class="k">for</span> <span class="n">row_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_rows</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="c1"># Retrieve the current row to check what data it has</span>
        <span class="n">row_cells</span> <span class="o">=</span> <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">get_sheet</span><span class="p">(</span>
            <span class="n">start_row</span><span class="o">=</span><span class="n">row_index</span><span class="p">,</span> <span class="n">end_row</span><span class="o">=</span><span class="n">row_index</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">)</span>
        <span class="n">retrieved_cells</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">ExampleColumnNames</span><span class="p">,</span> <span class="n">MagicTableCell</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">example_column_definitions</span><span class="o">.</span><span class="n">get_column_name_by_order</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">column_order</span><span class="p">):</span> <span class="n">cell</span>
            <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">row_cells</span><span class="o">.</span><span class="n">magic_table_cells</span>
        <span class="p">}</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retrieved cells: </span><span class="si">{</span><span class="n">retrieved_cells</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">answer_cell</span> <span class="o">=</span> <span class="n">retrieved_cells</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ExampleColumnNames</span><span class="o">.</span><span class="n">ANSWER</span><span class="p">)</span>

        <span class="c1"># Check if the answer cell exists. This means that the answer was already generated.</span>
        <span class="k">if</span> <span class="n">answer_cell</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Answer found for row </span><span class="si">{</span><span class="n">row_index</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">answer_cell</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Get the section for this row (e.g., &quot;Finance&quot;, &quot;Team&quot;)</span>
            <span class="n">section_name</span> <span class="o">=</span> <span class="n">retrieved_cells</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ExampleColumnNames</span><span class="o">.</span><span class="n">SECTION</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">section_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No section found for row </span><span class="si">{</span><span class="n">row_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># STEP 4: Retrieve relevant content based on row metadata</span>
            <span class="c1"># Use the ContentRegistry to get all files tagged with this section</span>
            <span class="n">relevant_contents</span> <span class="o">=</span> <span class="n">content_registry</span><span class="o">.</span><span class="n">get_contents_by_metadata_key</span><span class="p">(</span>
                <span class="n">section_name</span><span class="o">.</span><span class="n">text</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">relevant_contents</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No contents found for section &#39;</span><span class="si">{</span><span class="n">section_name</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">relevant_contents</span><span class="p">)</span><span class="si">}</span><span class="s2"> content items for section &#39;</span><span class="si">{</span><span class="n">section_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            <span class="p">)</span>

            <span class="c1"># STEP 5: Create a reference registry for citation mapping</span>
            <span class="c1"># This creates temporary IDs like &quot;chunk_a1b2c3d4&quot; for each content item</span>
            <span class="c1"># These IDs will be used in inline citations: [chunk_a1b2c3d4]</span>
            <span class="n">chunk_prefix</span> <span class="o">=</span> <span class="s2">&quot;chunk&quot;</span>
            <span class="n">reference_registry</span> <span class="o">=</span> <span class="n">create_id_map</span><span class="p">(</span><span class="n">relevant_contents</span><span class="p">,</span> <span class="n">chunk_prefix</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reference registry: </span><span class="si">{</span><span class="n">reference_registry</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># STEP 6: Generate text with inline citations</span>
            <span class="c1"># In a real application, this would be AI-generated text with citations</span>
            <span class="c1"># Here we simulate it by listing the content titles with citation markers</span>
            <span class="n">simulated_text_generation_with_references</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;The following are the contents of the section: </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">chunk_id</span><span class="p">,</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">reference_registry</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Add inline citation in format [chunk_xxx]</span>
                <span class="n">simulated_text_generation_with_references</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">content</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">chunk_id</span><span class="si">}</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="c1"># STEP 7: Convert inline citations to clickable references</span>
            <span class="c1"># This transforms [chunk_a1b2c3d4] into numbered references like [1], [2]</span>
            <span class="c1"># The frontend will render these as clickable links to the source files</span>
            <span class="n">augmented_text</span> <span class="o">=</span> <span class="n">augmented_text_with_references_fn</span><span class="p">(</span>
                <span class="n">simulated_text_generation_with_references</span><span class="p">,</span>
                <span class="n">reference_registry</span><span class="p">,</span>  <span class="c1"># type: ignore[arg-type]</span>
                <span class="n">chunk_prefix</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;\[chunk_([a-zA-Z0-9\-]+)\]&quot;</span><span class="p">,</span>  <span class="c1"># Citation pattern to match</span>
            <span class="p">)</span>

            <span class="c1"># STEP 8: Update the table cell with referenced text</span>
            <span class="n">cells_to_update</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">MagicTableCell</span><span class="p">(</span>
                    <span class="n">row_order</span><span class="o">=</span><span class="n">row_index</span><span class="p">,</span>
                    <span class="n">column_order</span><span class="o">=</span><span class="n">example_column_definitions</span><span class="o">.</span><span class="n">get_column_by_name</span><span class="p">(</span>
                        <span class="n">ExampleColumnNames</span><span class="o">.</span><span class="n">ANSWER</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">order</span><span class="p">,</span>
                    <span class="n">text</span><span class="o">=</span><span class="n">augmented_text</span><span class="p">,</span>
                    <span class="n">sheet_id</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">table_id</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="c1"># Apply any cell updates</span>
    <span class="k">if</span> <span class="n">cells_to_update</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">set_multiple_cells</span><span class="p">(</span><span class="n">cells</span><span class="o">=</span><span class="n">cells_to_update</span><span class="p">)</span>

    <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">set_activity</span><span class="p">(</span>
        <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Successfully processed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_contents</span><span class="p">)</span><span class="si">}</span><span class="s2"> source files&quot;</span><span class="p">,</span>
        <span class="n">activity</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="n">ActivityStatus</span><span class="o">.</span><span class="n">COMPLETED</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_contents</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_metadata_added</span><span class="p">(</span>
    <span class="n">at_service</span><span class="p">:</span> <span class="n">AgenticTableService</span><span class="p">,</span>
    <span class="n">payload</span><span class="p">:</span> <span class="n">MagicTableAddMetadataPayload</span><span class="p">,</span>
    <span class="n">downloader_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">bytes</span><span class="p">],</span>
    <span class="n">file_content_getter_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Content</span> <span class="o">|</span> <span class="kc">None</span><span class="p">],</span>
    <span class="n">augmented_text_with_references_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
        <span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Content</span> <span class="o">|</span> <span class="n">ContentChunk</span><span class="p">],</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">str</span>
    <span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Example handler for the metadata addition event.</span>

<span class="sd">    This demo shows how to populate a table from uploaded files:</span>
<span class="sd">    - Process question files: Downloads CSV files and populates the table</span>
<span class="sd">    - Process source files: Retrieves content and groups by metadata</span>

<span class="sd">    Args:</span>
<span class="sd">        at_service: Service instance for table operations</span>
<span class="sd">        payload: Event payload with metadata and file IDs</span>
<span class="sd">        downloader_fn: Function to download file contents</span>
<span class="sd">        file_content_getter_fn: Function to retrieve file content objects</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing metadata for sheet: </span><span class="si">{</span><span class="n">payload</span><span class="o">.</span><span class="n">sheet_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Handle question files (CSV processing)</span>
        <span class="n">num_question_rows</span> <span class="o">=</span> <span class="k">await</span> <span class="n">handle_question_files</span><span class="p">(</span>
            <span class="n">at_service</span><span class="o">=</span><span class="n">at_service</span><span class="p">,</span>
            <span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span>
            <span class="n">downloader_fn</span><span class="o">=</span><span class="n">downloader_fn</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Handle source files (content and metadata processing)</span>
        <span class="n">num_source_rows</span> <span class="o">=</span> <span class="k">await</span> <span class="n">handle_source_files</span><span class="p">(</span>
            <span class="n">at_service</span><span class="o">=</span><span class="n">at_service</span><span class="p">,</span>
            <span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span>
            <span class="n">file_content_getter_fn</span><span class="o">=</span><span class="n">file_content_getter_fn</span><span class="p">,</span>
            <span class="n">augmented_text_with_references_fn</span><span class="o">=</span><span class="n">augmented_text_with_references_fn</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># This is different from the LogEntry which shows in the cell history</span>
        <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">set_activity</span><span class="p">(</span>
            <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Successfully loaded </span><span class="si">{</span><span class="n">num_question_rows</span><span class="si">}</span><span class="s2"> rows from CSV and </span><span class="si">{</span><span class="n">num_source_rows</span><span class="si">}</span><span class="s2"> source file metadata rows&quot;</span><span class="p">,</span>
            <span class="n">activity</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="n">ActivityStatus</span><span class="o">.</span><span class="n">COMPLETED</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing files: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">set_activity</span><span class="p">(</span>
            <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Failed to process files: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">activity</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="n">ActivityStatus</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">raise</span>
</code></pre></div>
</div>
</div>
</div>
</details>
<h3 id="handler-3-cell-updated-event">Handler 3: Cell Updated Event<a class="headerlink" href="#handler-3-cell-updated-event" title="Permanent link">&para;</a></h3>
<p><strong>When</strong>: Triggered when a user edits an editable cell.</p>
<p><strong>Goal</strong>: Implement business rules that react to cell changes. In this example, we monitor a specific column and lock rows when they reach a certain state.</p>
<p><strong>What we do with <code>at_service</code></strong>:</p>
<ul>
<li><code>set_cell()</code> - Updates the cell with additional context (log entries)</li>
<li><code>update_row_verification_status()</code> - Changes the verification status of entire rows (can be used to lock/unlock or mark as verified)</li>
</ul>
<p>This handler demonstrates workflow automation. The example checks if the "Critical Consistency" column is changed to "Consistent" and then:</p>
<ol>
<li>Adds a log entry documenting the change (creates an audit trail)</li>
<li>Marks the row as verified (which can trigger visual indicators or prevent further edits)</li>
</ol>
<p>You could extend this pattern to:</p>
<ul>
<li>Regenerate AI responses when questions are modified</li>
<li>Trigger validation workflows</li>
<li>Update dependent cells automatically</li>
<li>Send notifications or trigger external systems</li>
<li>Implement approval chains or review processes</li>
</ul>
<p>The power here is in defining your business logic - the framework just provides the hooks.</p>
<details class="example">
<summary>Cell Updated Handler Implementation (Click to expand)</summary>
<div class="tabbed-set tabbed-alternate" data-tabs="4:1"><input checked="checked" id="__tabbed_4_1" name="__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="__tabbed_4_1">Cell Updated Handler</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">unique_toolkit.agentic_table.schemas</span><span class="w"> </span><span class="kn">import</span> <span class="n">MagicTableUpdateCellPayload</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unique_toolkit.agentic_table.service</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgenticTableService</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">getLogger</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unique_toolkit.language_model.schemas</span><span class="w"> </span><span class="kn">import</span> <span class="n">LanguageModelMessageRole</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unique_sdk</span><span class="w"> </span><span class="kn">import</span> <span class="n">RowVerificationStatus</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unique_toolkit.agentic_table.schemas</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogEntry</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.agentic_table_example_column_definition</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">example_column_definitions</span><span class="p">,</span>
    <span class="n">ExampleColumnNames</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_cell_updated</span><span class="p">(</span>
    <span class="n">at_service</span><span class="p">:</span> <span class="n">AgenticTableService</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">MagicTableUpdateCellPayload</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Example handler for the cell update event.</span>

<span class="sd">    This demo shows a simple workflow automation: when the Critical Consistency column</span>
<span class="sd">    changes to &quot;Consistent&quot;, it adds a log entry and updates</span>
<span class="sd">    the row verification status.</span>

<span class="sd">    Args:</span>
<span class="sd">        at_service: Service instance for table operations</span>
<span class="sd">        payload: Event payload with row, column, and new value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Cell updated at row </span><span class="si">{</span><span class="n">payload</span><span class="o">.</span><span class="n">row_order</span><span class="si">}</span><span class="s2">, &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;column </span><span class="si">{</span><span class="n">payload</span><span class="o">.</span><span class="n">column_order</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">payload</span><span class="o">.</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="n">critical_consistency_col</span> <span class="o">=</span> <span class="n">example_column_definitions</span><span class="o">.</span><span class="n">get_column_by_name</span><span class="p">(</span>
        <span class="n">ExampleColumnNames</span><span class="o">.</span><span class="n">CRITICAL_CONSISTENCY</span>
    <span class="p">)</span>

    <span class="c1"># Check if the Critical Consistency column was updated</span>
    <span class="k">if</span> <span class="n">payload</span><span class="o">.</span><span class="n">column_order</span> <span class="o">==</span> <span class="n">critical_consistency_col</span><span class="o">.</span><span class="n">order</span><span class="p">:</span>
        <span class="n">status_value</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Status changed to: </span><span class="si">{</span><span class="n">status_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Check if status is Completed or Verified (lock row)</span>
        <span class="k">if</span> <span class="n">status_value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;consistent&quot;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Locking row </span><span class="si">{</span><span class="n">payload</span><span class="o">.</span><span class="n">row_order</span><span class="si">}</span><span class="s2"> due to status: </span><span class="si">{</span><span class="n">status_value</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Note: Column-level locking affects all rows. In a production system,</span>
            <span class="c1"># you might track locked rows in metadata and validate edits server-side.</span>
            <span class="c1"># Here we demonstrate the pattern with a log entry.</span>

            <span class="c1"># Add log entry to document the status change and locking</span>
            <span class="n">log_entries</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">LogEntry</span><span class="p">(</span>
                    <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Row </span><span class="si">{</span><span class="n">payload</span><span class="o">.</span><span class="n">row_order</span><span class="si">}</span><span class="s2"> marked as </span><span class="si">{</span><span class="n">status_value</span><span class="si">}</span><span class="s2">. Further edits should be restricted.&quot;</span><span class="p">,</span>
                    <span class="n">created_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                    <span class="n">actor_type</span><span class="o">=</span><span class="n">LanguageModelMessageRole</span><span class="o">.</span><span class="n">ASSISTANT</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">]</span>

            <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">set_cell</span><span class="p">(</span>
                <span class="n">row</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">row_order</span><span class="p">,</span>
                <span class="n">column</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">column_order</span><span class="p">,</span>
                <span class="n">text</span><span class="o">=</span><span class="n">status_value</span><span class="p">,</span>
                <span class="n">log_entries</span><span class="o">=</span><span class="n">log_entries</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Update row verification status</span>
            <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">update_row_verification_status</span><span class="p">(</span>
                <span class="n">row_orders</span><span class="o">=</span><span class="p">[</span><span class="n">payload</span><span class="o">.</span><span class="n">row_order</span><span class="p">],</span> <span class="n">status</span><span class="o">=</span><span class="n">RowVerificationStatus</span><span class="o">.</span><span class="n">VERIFIED</span>
            <span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Row </span><span class="si">{</span><span class="n">payload</span><span class="o">.</span><span class="n">row_order</span><span class="si">}</span><span class="s2"> verified and logged&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
</div>
</div>
</details>
<h3 id="handler-4-artifact-generation-event">Handler 4: Artifact Generation Event<a class="headerlink" href="#handler-4-artifact-generation-event" title="Permanent link">&para;</a></h3>
<p><strong>When</strong>: Triggered when a user clicks a button to generate a document or report.</p>
<p><strong>Goal</strong>: Create exportable artifacts from table data. In this example, we generate a formatted Word document, but you could create any type of output.</p>
<p><strong>What we do with <code>at_service</code></strong>:</p>
<ul>
<li><code>set_activity()</code> - Provides progress updates during the potentially long-running generation process</li>
<li><code>get_sheet()</code> - Retrieves all table data (you can specify row ranges for large tables)</li>
<li><code>set_artifact()</code> - Links the generated file back to the table so users can easily find and download it</li>
</ul>
<p>This handler shows the complete artifact generation workflow:</p>
<ol>
<li>Read table data</li>
<li>Process/transform it (here we group by sections and format as markdown)</li>
<li>Generate output file (DOCX in this case)</li>
<li>Upload to the content system</li>
<li>Link back to the table as an artifact</li>
</ol>
<p>You could make this much more sophisticated:</p>
<ul>
<li>Use AI agents to synthesize intelligent summaries</li>
<li>Generate multiple artifact types (PDF, Excel, PowerPoint)</li>
<li>Include charts, visualizations, or analytics</li>
<li>Apply custom templates and branding</li>
<li>Add conditional logic based on table content</li>
</ul>
<p>The example demonstrates the basic pattern - reading data, transforming it, and creating a downloadable result.</p>
<details class="example">
<summary>Artifact Generation Handler Implementation (Click to expand)</summary>
<div class="tabbed-set tabbed-alternate" data-tabs="5:1"><input checked="checked" id="__tabbed_5_1" name="__tabbed_5" type="radio" /><div class="tabbed-labels"><label for="__tabbed_5_1">Artifact Generated Handler</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">getLogger</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">unique_sdk.api_resources._agentic_table</span><span class="w"> </span><span class="kn">import</span> <span class="n">ActivityStatus</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">unique_toolkit._common.docx_generator</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">DocxGeneratorConfig</span><span class="p">,</span>
    <span class="n">DocxGeneratorService</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unique_toolkit.agentic_table.schemas</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">MagicTableGenerateArtifactPayload</span><span class="p">,</span>
    <span class="n">MagicTableSheet</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unique_toolkit.agentic_table.service</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgenticTableService</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unique_toolkit.content.schemas</span><span class="w"> </span><span class="kn">import</span> <span class="n">Content</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.agentic_table_example_column_definition</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">ExampleColumnNames</span><span class="p">,</span>
    <span class="n">example_column_definitions</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_artifact_generated</span><span class="p">(</span>
    <span class="n">at_service</span><span class="p">:</span> <span class="n">AgenticTableService</span><span class="p">,</span>
    <span class="n">payload</span><span class="p">:</span> <span class="n">MagicTableGenerateArtifactPayload</span><span class="p">,</span>
    <span class="n">uploader_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">Content</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Example handler for the artifact generation event.</span>

<span class="sd">    This demo shows how to export table data as a Word document:</span>
<span class="sd">    - Fetches all table data</span>
<span class="sd">    - Organizes it by sections</span>
<span class="sd">    - Generates a markdown report</span>
<span class="sd">    - Converts to DOCX and uploads it</span>
<span class="sd">    - Links the artifact back to the table</span>

<span class="sd">    Args:</span>
<span class="sd">        at_service: Service instance for table operations</span>
<span class="sd">        payload: Event payload with artifact type</span>
<span class="sd">        uploader_fn: Function to upload the generated file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating artifact of type: </span><span class="si">{</span><span class="n">payload</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">artifact_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">set_activity</span><span class="p">(</span>
        <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Starting report generation...&quot;</span><span class="p">,</span>
        <span class="n">activity</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="n">ActivityStatus</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Read and organize data</span>
        <span class="n">sheet</span> <span class="o">=</span> <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">get_sheet</span><span class="p">(</span><span class="n">start_row</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">end_row</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">rows_data</span> <span class="o">=</span> <span class="n">organize_sheet_data</span><span class="p">(</span><span class="n">sheet</span><span class="p">)</span>

        <span class="c1"># Build markdown report</span>
        <span class="n">markdown</span> <span class="o">=</span> <span class="n">build_markdown_report</span><span class="p">(</span><span class="n">rows_data</span><span class="p">)</span>

        <span class="c1"># Generate DOCX</span>
        <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">set_activity</span><span class="p">(</span>
            <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Generating document...&quot;</span><span class="p">,</span>
            <span class="n">activity</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="n">ActivityStatus</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">docx_generator</span> <span class="o">=</span> <span class="n">DocxGeneratorService</span><span class="p">(</span>
            <span class="n">config</span><span class="o">=</span><span class="n">DocxGeneratorConfig</span><span class="p">(</span>
                <span class="n">template_content_id</span><span class="o">=</span><span class="s2">&quot;content-template-generic&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">content_fields</span> <span class="o">=</span> <span class="n">docx_generator</span><span class="o">.</span><span class="n">parse_markdown_to_list_content_fields</span><span class="p">(</span><span class="n">markdown</span><span class="p">)</span>
        <span class="n">docx_file</span> <span class="o">=</span> <span class="n">docx_generator</span><span class="o">.</span><span class="n">generate_from_template</span><span class="p">(</span><span class="n">content_fields</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">docx_file</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to generate DOCX file&quot;</span><span class="p">)</span>

        <span class="c1"># Upload to chat</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Table_Report_</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">.docx&quot;</span>

        <span class="n">content</span> <span class="o">=</span> <span class="n">uploader_fn</span><span class="p">(</span>
            <span class="n">docx_file</span><span class="p">,</span>
            <span class="s2">&quot;application/vnd.openxmlformats-officedocument.wordprocessingml.document&quot;</span><span class="p">,</span>
            <span class="n">filename</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Set artifact reference</span>
        <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">set_artifact</span><span class="p">(</span>
            <span class="n">artifact_type</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">artifact_type</span><span class="p">,</span>
            <span class="n">content_id</span><span class="o">=</span><span class="n">content</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">mime_type</span><span class="o">=</span><span class="s2">&quot;application/vnd.openxmlformats-officedocument.wordprocessingml.document&quot;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">set_activity</span><span class="p">(</span>
            <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Report generated successfully: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">activity</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="n">ActivityStatus</span><span class="o">.</span><span class="n">COMPLETED</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error generating artifact: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">set_activity</span><span class="p">(</span>
            <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Report generation failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">activity</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="n">ActivityStatus</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">raise</span>


<span class="k">def</span><span class="w"> </span><span class="nf">organize_sheet_data</span><span class="p">(</span><span class="n">sheet</span><span class="p">:</span> <span class="n">MagicTableSheet</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert flat cell list to nested dictionary structure.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with structure {row_order: {column_order: cell_text}}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rows_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">sheet</span><span class="o">.</span><span class="n">magic_table_cells</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cell</span><span class="o">.</span><span class="n">row_order</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rows_data</span><span class="p">:</span>
            <span class="n">rows_data</span><span class="p">[</span><span class="n">cell</span><span class="o">.</span><span class="n">row_order</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">rows_data</span><span class="p">[</span><span class="n">cell</span><span class="o">.</span><span class="n">row_order</span><span class="p">][</span><span class="n">cell</span><span class="o">.</span><span class="n">column_order</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">text</span>

    <span class="k">return</span> <span class="n">rows_data</span>


<span class="k">def</span><span class="w"> </span><span class="nf">build_markdown_report</span><span class="p">(</span><span class="n">rows_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a markdown report grouped by sections.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Markdown string with sections and question details</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">markdown_lines</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;# Table Report&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;**Generated:** </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;---&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="c1"># Get column indices</span>
    <span class="n">question_col</span> <span class="o">=</span> <span class="n">example_column_definitions</span><span class="o">.</span><span class="n">get_column_by_name</span><span class="p">(</span>
        <span class="n">ExampleColumnNames</span><span class="o">.</span><span class="n">QUESTION</span>
    <span class="p">)</span><span class="o">.</span><span class="n">order</span>
    <span class="n">section_col</span> <span class="o">=</span> <span class="n">example_column_definitions</span><span class="o">.</span><span class="n">get_column_by_name</span><span class="p">(</span>
        <span class="n">ExampleColumnNames</span><span class="o">.</span><span class="n">SECTION</span>
    <span class="p">)</span><span class="o">.</span><span class="n">order</span>
    <span class="n">answer_col</span> <span class="o">=</span> <span class="n">example_column_definitions</span><span class="o">.</span><span class="n">get_column_by_name</span><span class="p">(</span>
        <span class="n">ExampleColumnNames</span><span class="o">.</span><span class="n">ANSWER</span>
    <span class="p">)</span><span class="o">.</span><span class="n">order</span>
    <span class="n">consistency_col</span> <span class="o">=</span> <span class="n">example_column_definitions</span><span class="o">.</span><span class="n">get_column_by_name</span><span class="p">(</span>
        <span class="n">ExampleColumnNames</span><span class="o">.</span><span class="n">CRITICAL_CONSISTENCY</span>
    <span class="p">)</span><span class="o">.</span><span class="n">order</span>
    <span class="n">status_col</span> <span class="o">=</span> <span class="n">example_column_definitions</span><span class="o">.</span><span class="n">get_column_by_name</span><span class="p">(</span>
        <span class="n">ExampleColumnNames</span><span class="o">.</span><span class="n">STATUS</span>
    <span class="p">)</span><span class="o">.</span><span class="n">order</span>
    <span class="n">reviewer_col</span> <span class="o">=</span> <span class="n">example_column_definitions</span><span class="o">.</span><span class="n">get_column_by_name</span><span class="p">(</span>
        <span class="n">ExampleColumnNames</span><span class="o">.</span><span class="n">REVIEWER</span>
    <span class="p">)</span><span class="o">.</span><span class="n">order</span>

    <span class="c1"># Get data rows (excluding header row 0)</span>
    <span class="n">data_rows</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rows_data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">}</span>

    <span class="c1"># Group by section</span>
    <span class="n">sections</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">row_data</span> <span class="ow">in</span> <span class="n">data_rows</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">section</span> <span class="o">=</span> <span class="n">row_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section_col</span><span class="p">,</span> <span class="s2">&quot;General&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">section</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sections</span><span class="p">:</span>
            <span class="n">sections</span><span class="p">[</span><span class="n">section</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sections</span><span class="p">[</span><span class="n">section</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row_data</span><span class="p">)</span>

    <span class="c1"># Add each section</span>
    <span class="k">for</span> <span class="n">section_name</span><span class="p">,</span> <span class="n">section_rows</span> <span class="ow">in</span> <span class="n">sections</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">markdown_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="sa">f</span><span class="s2">&quot;## </span><span class="si">{</span><span class="n">section_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">row_data</span> <span class="ow">in</span> <span class="n">section_rows</span><span class="p">:</span>
            <span class="n">question</span> <span class="o">=</span> <span class="n">row_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">question_col</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">)</span>
            <span class="n">answer</span> <span class="o">=</span> <span class="n">row_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">answer_col</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">)</span>
            <span class="n">consistency</span> <span class="o">=</span> <span class="n">row_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">consistency_col</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">)</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">row_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">status_col</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">)</span>
            <span class="n">reviewer</span> <span class="o">=</span> <span class="n">row_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">reviewer_col</span><span class="p">,</span> <span class="s2">&quot;Unassigned&quot;</span><span class="p">)</span>

            <span class="n">markdown_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="sa">f</span><span class="s2">&quot;**Question:** </span><span class="si">{</span><span class="n">question</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;**Answer:** </span><span class="si">{</span><span class="n">answer</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;**Consistency:** </span><span class="si">{</span><span class="n">consistency</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;**Status:** </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;**Reviewer:** </span><span class="si">{</span><span class="n">reviewer</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;---&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">markdown_lines</span><span class="p">)</span>
</code></pre></div>
</div>
</div>
</div>
</details>
<h2 id="framework-utilities-helper-functions">Framework Utilities: Helper Functions<a class="headerlink" href="#framework-utilities-helper-functions" title="Permanent link">&para;</a></h2>
<p>The tutorial examples use several helper functions that encapsulate common patterns for working with files, metadata, and references. These are available in the toolkit and demonstrate best practices for your own applications.</p>
<h3 id="file-content-retrieval">File Content Retrieval<a class="headerlink" href="#file-content-retrieval" title="Permanent link">&para;</a></h3>
<p><strong>Function</strong>: <code>get_file_content_getter_fn(user_id, company_id, chat_id)</code></p>
<p>Creates a function to retrieve full <code>Content</code> objects by file ID. This is essential for accessing file metadata and properties.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Create the getter function with authentication context</span>
<span class="n">file_content_getter</span> <span class="o">=</span> <span class="n">get_file_content_getter_fn</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">company_id</span><span class="p">,</span> <span class="n">chat_id</span><span class="p">)</span>

<span class="c1"># Retrieve content by ID</span>
<span class="n">content</span> <span class="o">=</span> <span class="n">file_content_getter</span><span class="p">(</span><span class="n">file_id</span><span class="p">)</span>

<span class="c1"># Access properties</span>
<span class="k">if</span> <span class="n">content</span><span class="p">:</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">metadata</span>  <span class="c1"># Custom key-value pairs</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">title</span>        <span class="c1"># File name</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">text</span>          <span class="c1"># Extracted text</span>
    <span class="n">chunks</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">chunks</span>      <span class="c1"># ContentChunk objects</span>
</code></pre></div>
<p><strong>Use in your handlers</strong>: Pass this function to handlers that need to access source file metadata.</p>
<h3 id="file-download">File Download<a class="headerlink" href="#file-download" title="Permanent link">&para;</a></h3>
<p><strong>Function</strong>: <code>get_downloader_fn(user_id, company_id, chat_id)</code></p>
<p>Creates a function to download raw file bytes. Useful for processing CSV, Excel, or other binary formats.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Create the downloader with authentication context</span>
<span class="n">downloader</span> <span class="o">=</span> <span class="n">get_downloader_fn</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">company_id</span><span class="p">,</span> <span class="n">chat_id</span><span class="p">)</span>

<span class="c1"># Download file content</span>
<span class="n">file_bytes</span> <span class="o">=</span> <span class="n">downloader</span><span class="p">(</span><span class="n">file_id</span><span class="p">)</span>

<span class="c1"># Process the bytes (e.g., parse CSV)</span>
<span class="n">csv_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">file_bytes</span><span class="p">))</span>
</code></pre></div>
<p><strong>Use in your handlers</strong>: Pass this function to handlers that need to download and process file contents.</p>
<h3 id="file-upload">File Upload<a class="headerlink" href="#file-upload" title="Permanent link">&para;</a></h3>
<p><strong>Function</strong>: <code>get_uploader_fn(user_id, company_id, chat_id)</code></p>
<p>Creates a function to upload files to the chat. Used for uploading generated artifacts.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Create the uploader with authentication context</span>
<span class="n">uploader</span> <span class="o">=</span> <span class="n">get_uploader_fn</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">company_id</span><span class="p">,</span> <span class="n">chat_id</span><span class="p">)</span>

<span class="c1"># Upload a file</span>
<span class="n">content</span> <span class="o">=</span> <span class="n">uploader</span><span class="p">(</span>
    <span class="n">file_bytes</span><span class="p">,</span>
    <span class="s2">&quot;application/vnd.openxmlformats-officedocument.wordprocessingml.document&quot;</span><span class="p">,</span>
    <span class="s2">&quot;report.docx&quot;</span>
<span class="p">)</span>

<span class="c1"># Use the returned content ID</span>
<span class="n">content_id</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">id</span>
</code></pre></div>
<p><strong>Use in your handlers</strong>: Pass this function to artifact generation handlers.</p>
<h3 id="reference-creation">Reference Creation<a class="headerlink" href="#reference-creation" title="Permanent link">&para;</a></h3>
<p><strong>Function</strong>: <code>get_augmented_text_with_references_fn(user_id, company_id, chat_id, assistant_id)</code></p>
<p>Creates a function to convert inline citations into clickable references. This is the core utility for building traceable, source-linked content.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Create the reference builder with authentication context</span>
<span class="n">reference_builder</span> <span class="o">=</span> <span class="n">get_augmented_text_with_references_fn</span><span class="p">(</span>
    <span class="n">user_id</span><span class="p">,</span> <span class="n">company_id</span><span class="p">,</span> <span class="n">chat_id</span><span class="p">,</span> <span class="n">assistant_id</span>
<span class="p">)</span>

<span class="c1"># Create a reference registry</span>
<span class="n">reference_registry</span> <span class="o">=</span> <span class="n">create_id_map</span><span class="p">(</span><span class="n">content_items</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;chunk&quot;</span><span class="p">)</span>

<span class="c1"># Convert citations to references</span>
<span class="n">text_with_citations</span> <span class="o">=</span> <span class="s2">&quot;According to the report [chunk_abc123]...&quot;</span>
<span class="n">augmented_text</span> <span class="o">=</span> <span class="n">reference_builder</span><span class="p">(</span>
    <span class="n">text_with_citations</span><span class="p">,</span>
    <span class="n">reference_registry</span><span class="p">,</span>
    <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;chunk&quot;</span><span class="p">,</span>
    <span class="n">citation_pattern</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;\[chunk_([a-zA-Z0-9\-]+)\]&quot;</span>
<span class="p">)</span>
<span class="c1"># Result: &quot;According to the report [1]...&quot; (clickable in UI)</span>
</code></pre></div>
<p><strong>Use in your handlers</strong>: Pass this function to handlers that generate AI content with source citations.</p>
<h3 id="content-organization">Content Organization<a class="headerlink" href="#content-organization" title="Permanent link">&para;</a></h3>
<p><strong>Class</strong>: <code>ContentRegistry(keys, contents)</code></p>
<p>An <strong>example</strong> utility class demonstrating how to organize Content objects by metadata keys. This is just one approach - you should implement your own filtering logic based on your specific needs.</p>
<p><strong>Example usage</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Create a registry with metadata keys</span>
<span class="n">content_registry</span> <span class="o">=</span> <span class="n">ContentRegistry</span><span class="p">(</span>
    <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Finance&quot;</span><span class="p">,</span> <span class="s2">&quot;Legal&quot;</span><span class="p">,</span> <span class="s2">&quot;Technical&quot;</span><span class="p">],</span>
    <span class="n">contents</span><span class="o">=</span><span class="n">all_content_objects</span>
<span class="p">)</span>

<span class="c1"># Retrieve files by metadata key</span>
<span class="n">finance_files</span> <span class="o">=</span> <span class="n">content_registry</span><span class="o">.</span><span class="n">get_contents_by_metadata_key</span><span class="p">(</span><span class="s2">&quot;Finance&quot;</span><span class="p">)</span>
<span class="n">legal_files</span> <span class="o">=</span> <span class="n">content_registry</span><span class="o">.</span><span class="n">get_contents_by_metadata_key</span><span class="p">(</span><span class="s2">&quot;Legal&quot;</span><span class="p">)</span>
</code></pre></div>
<p><strong>This example shows</strong>: Grouping by metadata key existence (e.g., file has <code>{"Finance": "true"}</code>)</p>
<p><strong>Your implementation might</strong>:
- Filter by metadata <strong>values</strong> instead of keys (e.g., <code>{"status": "approved"}</code>)
- Support complex queries (AND/OR conditions, ranges, regex)
- Combine multiple metadata attributes (e.g., section AND department)
- Implement scoring/ranking logic for content relevance
- Use caching strategies for large content sets</p>
<p><strong>Key point</strong>: Build your own registry class that matches your business logic and metadata structure!</p>
<h3 id="id-mapping">ID Mapping<a class="headerlink" href="#id-mapping" title="Permanent link">&para;</a></h3>
<p><strong>Function</strong>: <code>create_id_map(items, prefix)</code></p>
<p>Generates temporary IDs for a list of items. Essential for creating citation systems.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Create unique IDs for content items</span>
<span class="n">id_map</span> <span class="o">=</span> <span class="n">create_id_map</span><span class="p">(</span><span class="n">content_list</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;chunk&quot;</span><span class="p">)</span>
<span class="c1"># Returns: {&quot;chunk_a1b2c3d4&quot;: content1, &quot;chunk_x9y8z7w6&quot;: content2, ...}</span>

<span class="c1"># Use in text generation</span>
<span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;See source [</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">id_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">]&quot;</span>
</code></pre></div>
<p><strong>Pattern</strong>: Always use consistent prefixes and citation patterns throughout your application.</p>
<details class="example">
<summary>Helper Functions Implementation (Click to expand)</summary>
<div class="tabbed-set tabbed-alternate" data-tabs="6:1"><input checked="checked" id="__tabbed_6_1" name="__tabbed_6" type="radio" /><div class="tabbed-labels"><label for="__tabbed_6_1">Helper Functions</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">getLogger</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">TypeVar</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">unique_toolkit.chat</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatMessageRole</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unique_toolkit.content</span><span class="w"> </span><span class="kn">import</span> <span class="n">ContentChunk</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unique_toolkit.content.schemas</span><span class="w"> </span><span class="kn">import</span> <span class="n">Content</span><span class="p">,</span> <span class="n">ContentReference</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_file_content_getter_fn</span><span class="p">(</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">company_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">chat_id</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Content</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Factory function to create a content retriever with authentication context.</span>

<span class="sd">    The returned function allows you to:</span>
<span class="sd">    - Retrieve full Content objects by file ID</span>
<span class="sd">    - Access file metadata (custom key-value pairs attached during upload)</span>
<span class="sd">    - Access file chunks (for chunked documents)</span>
<span class="sd">    - Access file text and other properties</span>

<span class="sd">    Returns:</span>
<span class="sd">        A function that retrieves Content by file_id, or None if not found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">unique_toolkit.content.functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">search_contents</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_content_fn</span><span class="p">(</span><span class="n">file_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Content</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Search for content by exact ID match</span>
        <span class="n">where</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;equals&quot;</span><span class="p">:</span> <span class="n">file_id</span><span class="p">}}</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">search_contents</span><span class="p">(</span>
            <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">company_id</span><span class="o">=</span><span class="n">company_id</span><span class="p">,</span> <span class="n">chat_id</span><span class="o">=</span><span class="n">chat_id</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">where</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No content info found for file: </span><span class="si">{</span><span class="n">file_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">contents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No metadata found for file: </span><span class="si">{</span><span class="n">file_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Metadata for file </span><span class="si">{</span><span class="n">file_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">contents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">metadata</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">contents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">get_content_fn</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_downloader_fn</span><span class="p">(</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">company_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">chat_id</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">bytes</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Factory function to create a file downloader with authentication context.</span>

<span class="sd">    Returns a function that downloads files by content_id.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">unique_toolkit.content.functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">download_content_to_bytes</span>

    <span class="k">return</span> <span class="k">lambda</span> <span class="n">file_id</span><span class="p">:</span> <span class="n">download_content_to_bytes</span><span class="p">(</span>
        <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">company_id</span><span class="o">=</span><span class="n">company_id</span><span class="p">,</span> <span class="n">chat_id</span><span class="o">=</span><span class="n">chat_id</span><span class="p">,</span> <span class="n">content_id</span><span class="o">=</span><span class="n">file_id</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_uploader_fn</span><span class="p">(</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">company_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">chat_id</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">Content</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Factory function to create a file uploader with authentication context.</span>

<span class="sd">    Returns a function that uploads files to the chat.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">unique_toolkit.content.functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">upload_content_from_bytes</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">uploader</span><span class="p">(</span><span class="n">content</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">mime_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">content_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Content</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">upload_content_from_bytes</span><span class="p">(</span>
            <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
            <span class="n">company_id</span><span class="o">=</span><span class="n">company_id</span><span class="p">,</span>
            <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
            <span class="n">mime_type</span><span class="o">=</span><span class="n">mime_type</span><span class="p">,</span>
            <span class="n">content_name</span><span class="o">=</span><span class="n">content_name</span><span class="p">,</span>
            <span class="n">chat_id</span><span class="o">=</span><span class="n">chat_id</span><span class="p">,</span>
            <span class="n">skip_ingestion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">uploader</span>


<span class="k">def</span><span class="w"> </span><span class="nf">convert_content_chunk_to_reference</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">message_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">content_or_chunk</span><span class="p">:</span> <span class="n">Content</span> <span class="o">|</span> <span class="n">ContentChunk</span><span class="p">,</span>
    <span class="n">sequence_number</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">start_page</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">end_page</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ContentReference</span><span class="p">:</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">content_or_chunk</span><span class="o">.</span><span class="n">title</span> <span class="ow">or</span> <span class="n">content_or_chunk</span><span class="o">.</span><span class="n">key</span> <span class="ow">or</span> <span class="n">content_or_chunk</span><span class="o">.</span><span class="n">id</span>

    <span class="n">page_suffix</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">start_page</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">end_page</span><span class="p">:</span>
            <span class="n">page_suffix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;: </span><span class="si">{</span><span class="n">start_page</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">end_page</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">page_suffix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;: </span><span class="si">{</span><span class="n">start_page</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">title</span><span class="si">}{</span><span class="n">page_suffix</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">page_suffix</span> <span class="k">else</span> <span class="n">title</span>

    <span class="k">return</span> <span class="n">ContentReference</span><span class="p">(</span>
        <span class="n">message_id</span><span class="o">=</span><span class="n">message_id</span><span class="p">,</span>
        <span class="n">url</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;unique://content/</span><span class="si">{</span><span class="n">content_or_chunk</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">source_id</span><span class="o">=</span><span class="n">content_or_chunk</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
        <span class="n">sequence_number</span><span class="o">=</span><span class="n">sequence_number</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">source</span><span class="o">=</span><span class="s2">&quot;agentic-table&quot;</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_augmented_text_with_references_fn</span><span class="p">(</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">company_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">chat_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">assistant_id</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Content</span> <span class="o">|</span> <span class="n">ContentChunk</span><span class="p">],</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Factory function to create a reference builder with authentication context.</span>

<span class="sd">    The returned function converts inline citations in text (e.g., [chunk_abc123]) into </span>
<span class="sd">    clickable references in the Unique UI. These references:</span>
<span class="sd">    - Appear as numbered citations (e.g., [1], [2]) in the frontend</span>
<span class="sd">    - Are clickable and navigate to the source content</span>
<span class="sd">    - Include metadata like title, page numbers, and source ID</span>

<span class="sd">    This is useful when:</span>
<span class="sd">    - AI agents generate text with citations to source documents</span>
<span class="sd">    - You want to create audit trails linking table cells to source files</span>
<span class="sd">    - You need to show provenance of data in the table</span>

<span class="sd">    Returns:</span>
<span class="sd">        A function that converts inline citations to numbered references</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">unique_toolkit.chat.functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_message</span><span class="p">,</span> <span class="n">modify_message</span>

    <span class="c1"># Default pattern matches citations like [chunk_abc123] or [chunk_xyz-456]</span>
    <span class="n">_DEFAULT_CITATION_PATTERN</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\[chunk_([a-zA-Z0-9\-]+)\]&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reference_builder</span><span class="p">(</span>
        <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">reference_registry</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Content</span> <span class="o">|</span> <span class="n">ContentChunk</span><span class="p">],</span>
        <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;chunk&quot;</span><span class="p">,</span>
        <span class="n">citation_pattern</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">_DEFAULT_CITATION_PATTERN</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts inline citations in text to numbered references with full content metadata.</span>

<span class="sd">        This function:</span>
<span class="sd">        1. Extracts all citation IDs from the text (e.g., [chunk_abc123])</span>
<span class="sd">        2. Looks up each citation in the reference registry</span>
<span class="sd">        3. Converts them to numbered references (e.g., [1&amp;message_id])</span>
<span class="sd">        4. Creates a message with the processed text and reference metadata</span>

<span class="sd">        Args:</span>
<span class="sd">            text: The text containing inline citations in format [chunk_xxx].</span>
<span class="sd">            reference_registry: Dictionary mapping citation IDs to their full Content or ContentChunk objects.</span>
<span class="sd">            citation_pattern: Regex pattern to extract citation IDs from text (default matches [chunk_xxx]).</span>

<span class="sd">        Returns:</span>
<span class="sd">            The processed text with inline citations converted to numbered references.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Create a new assistant message to hold the references</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">create_message</span><span class="p">(</span>
            <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
            <span class="n">company_id</span><span class="o">=</span><span class="n">company_id</span><span class="p">,</span>
            <span class="n">chat_id</span><span class="o">=</span><span class="n">chat_id</span><span class="p">,</span>
            <span class="n">assistant_id</span><span class="o">=</span><span class="n">assistant_id</span><span class="p">,</span>
            <span class="n">role</span><span class="o">=</span><span class="n">ChatMessageRole</span><span class="o">.</span><span class="n">ASSISTANT</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="n">message</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="c1"># Extract all citation IDs from the text (e.g., &quot;abc123&quot; from &quot;[chunk_abc123]&quot;)</span>
        <span class="n">chunk_ids</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">citation_pattern</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">chunk_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> chunk IDs in text&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Chunk IDs: </span><span class="si">{</span><span class="n">chunk_ids</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Track which citations we&#39;ve already processed to avoid duplicates</span>
        <span class="n">processed_citations</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Collect all reference metadata to attach to the message</span>
        <span class="n">message_references</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Process each citation found in the text</span>
        <span class="k">for</span> <span class="n">chunk_id</span> <span class="ow">in</span> <span class="n">chunk_ids</span><span class="p">:</span>
            <span class="c1"># Check if we&#39;ve already processed this citation</span>
            <span class="k">if</span> <span class="n">chunk_id</span> <span class="ow">in</span> <span class="n">processed_citations</span><span class="p">:</span>
                <span class="c1"># Reuse the same reference notation for duplicate citations</span>
                <span class="n">reference_notation</span> <span class="o">=</span> <span class="n">processed_citations</span><span class="p">[</span><span class="n">chunk_id</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Look up the full content/chunk object for this citation</span>
                <span class="n">referenced_content</span> <span class="o">=</span> <span class="n">reference_registry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">chunk_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">referenced_content</span><span class="p">:</span>
                    <span class="c1"># This is a valid citation - create a numbered reference</span>
                    <span class="n">sequence_number</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">processed_citations</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

                    <span class="c1"># Add the reference metadata to the message</span>
                    <span class="n">message_references</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">convert_content_chunk_to_reference</span><span class="p">(</span>
                            <span class="n">message_id</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                            <span class="n">content_or_chunk</span><span class="o">=</span><span class="n">referenced_content</span><span class="p">,</span>
                            <span class="n">sequence_number</span><span class="o">=</span><span class="n">sequence_number</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

                    <span class="c1"># Format: [sequence_number&amp;message_id] (e.g., [1&amp;msg_123])</span>
                    <span class="n">reference_notation</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">sequence_number</span><span class="si">}</span><span class="s2">&amp;</span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">]&quot;</span>
                    <span class="n">processed_citations</span><span class="p">[</span><span class="n">chunk_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">reference_notation</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Citation ID not found in registry - mark as invalid</span>
                    <span class="n">reference_notation</span> <span class="o">=</span> <span class="s2">&quot;[???]&quot;</span>

            <span class="c1"># Replace the inline citation with the reference notation</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[chunk_</span><span class="si">{</span><span class="n">chunk_id</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">reference_notation</span><span class="p">)</span>

        <span class="c1"># Update the message with the processed text and all references</span>
        <span class="n">modify_message</span><span class="p">(</span>
            <span class="n">assistant_message_id</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">user_message_id</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">user_message_text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span>
            <span class="n">assistant</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
            <span class="n">company_id</span><span class="o">=</span><span class="n">company_id</span><span class="p">,</span>
            <span class="n">chat_id</span><span class="o">=</span><span class="n">chat_id</span><span class="p">,</span>
            <span class="n">references</span><span class="o">=</span><span class="n">message_references</span><span class="p">,</span>
            <span class="n">content</span><span class="o">=</span><span class="n">text</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">text</span>

    <span class="k">return</span> <span class="n">reference_builder</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ContentRegistry</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An EXAMPLE utility class for organizing Content objects by metadata keys.</span>

<span class="sd">    This demonstrates ONE WAY to manage content with metadata. You should implement</span>
<span class="sd">    your own filtering logic based on your specific requirements.</span>

<span class="sd">    Example use case:</span>
<span class="sd">        If your source files have metadata like {&quot;section&quot;: &quot;Finance&quot;} or {&quot;section&quot;: &quot;Legal&quot;},</span>
<span class="sd">        this class groups them by those keys so you can retrieve all Finance-related files</span>
<span class="sd">        when processing a Finance row in your table.</span>

<span class="sd">    This is intentionally simple to show the pattern. For production use, consider:</span>
<span class="sd">    - Filtering by metadata VALUES, not just keys (e.g., {&quot;status&quot;: &quot;approved&quot;})</span>
<span class="sd">    - Complex queries (AND/OR conditions, ranges, regex patterns)</span>
<span class="sd">    - Multiple metadata attributes (e.g., section AND department)</span>
<span class="sd">    - Caching strategies for large content sets</span>
<span class="sd">    - Custom scoring/ranking logic for content relevance</span>

<span class="sd">    Build your own registry class that fits your business logic!</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">contents</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Content</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize with metadata keys and a list of Content objects.</span>

<span class="sd">        This example implementation groups content by checking if metadata keys exist.</span>
<span class="sd">        Your implementation might filter by metadata values, use complex queries,</span>
<span class="sd">        or implement completely different logic.</span>

<span class="sd">        Args:</span>
<span class="sd">            keys: List of metadata keys to group by (e.g., [&quot;Finance&quot;, &quot;Legal&quot;])</span>
<span class="sd">            contents: List of Content objects to organize</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keys</span> <span class="o">=</span> <span class="n">keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contents</span> <span class="o">=</span> <span class="n">contents</span>

        <span class="n">grouped</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">Content</span><span class="p">]]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

        <span class="c1"># Group content by metadata keys</span>
        <span class="k">for</span> <span class="n">content</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">content</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No metadata found for content: </span><span class="si">{</span><span class="n">content</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Check if any of our target keys exist in this content&#39;s metadata</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">content</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found metadata key: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> for content: </span><span class="si">{</span><span class="n">content</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">grouped</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">contents_by_key</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">grouped</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_contents_by_metadata_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Content</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve all content items that have the specified metadata key.</span>

<span class="sd">        Args:</span>
<span class="sd">            key: The metadata key to filter by</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of Content objects with that metadata key, or empty list if none found</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">contents_by_key</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[])</span>


<span class="n">T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">create_id_map</span><span class="p">(</span><span class="n">items</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">T</span><span class="p">],</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">T</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a mapping of generated IDs to items for use in reference systems.</span>

<span class="sd">    This helper generates unique IDs for a list of items (Content or ContentChunk objects)</span>
<span class="sd">    so they can be cited in text and later resolved back to their full objects.</span>

<span class="sd">    Args:</span>
<span class="sd">        items: List of items to create IDs for (typically Content or ContentChunk objects)</span>
<span class="sd">        prefix: Prefix for generated IDs (e.g., &quot;chunk&quot; creates IDs like &quot;chunk_a1b2c3d4&quot;)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary mapping generated IDs to items</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; contents = [content1, content2, content3]</span>
<span class="sd">        &gt;&gt;&gt; id_map = create_id_map(contents, &quot;chunk&quot;)</span>
<span class="sd">        &gt;&gt;&gt; # Returns: {&quot;chunk_a1b2c3d4&quot;: content1, &quot;chunk_x9y8z7w6&quot;: content2, ...}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">uuid</span><span class="w"> </span><span class="kn">import</span> <span class="n">uuid4</span>

    <span class="k">return</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">}</span>
</code></pre></div>
</div>
</div>
</div>
</details>
<h2 id="key-concepts">Key Concepts<a class="headerlink" href="#key-concepts" title="Permanent link">&para;</a></h2>
<h3 id="agent-registration">Agent Registration<a class="headerlink" href="#agent-registration" title="Permanent link">&para;</a></h3>
<p>Before processing any event, you must call <code>at_service.register_agent()</code>. This locks the table to prevent concurrent modifications. Always deregister in a <code>finally</code> block to ensure proper cleanup even if errors occur.</p>
<h3 id="activity-status-updates">Activity Status Updates<a class="headerlink" href="#activity-status-updates" title="Permanent link">&para;</a></h3>
<p>Use <code>at_service.set_activity()</code> liberally to communicate with users. These appear as status banners in the UI and are essential for long-running operations. Include:</p>
<ul>
<li>IN_PROGRESS status with descriptive text during processing</li>
<li>COMPLETED status when successful</li>
<li>FAILED status with error messages if something goes wrong</li>
</ul>
<h3 id="batch-operations">Batch Operations<a class="headerlink" href="#batch-operations" title="Permanent link">&para;</a></h3>
<p>The <code>set_multiple_cells()</code> method is crucial for performance when dealing with multiple cell updates. It's dramatically faster than individual <code>set_cell()</code> calls and reduces network overhead.</p>
<h3 id="file-operations-and-metadata-patterns">File Operations and Metadata Patterns<a class="headerlink" href="#file-operations-and-metadata-patterns" title="Permanent link">&para;</a></h3>
<p>The tutorial demonstrates factory functions that encapsulate authentication context. This pattern:</p>
<ul>
<li>Keeps authentication logic centralized</li>
<li>Makes handlers more testable</li>
<li>Simplifies the handler function signatures</li>
</ul>
<h4 id="file-download-pattern">File Download Pattern<a class="headerlink" href="#file-download-pattern" title="Permanent link">&para;</a></h4>
<p>Use <code>get_downloader_fn()</code> for downloading raw file bytes (CSV, Excel, binary formats):</p>
<div class="highlight"><pre><span></span><code><span class="n">downloader</span> <span class="o">=</span> <span class="n">get_downloader_fn</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">company_id</span><span class="p">,</span> <span class="n">chat_id</span><span class="p">)</span>
<span class="n">file_bytes</span> <span class="o">=</span> <span class="n">downloader</span><span class="p">(</span><span class="n">file_id</span><span class="p">)</span>
</code></pre></div>
<h4 id="content-retrieval-pattern">Content Retrieval Pattern<a class="headerlink" href="#content-retrieval-pattern" title="Permanent link">&para;</a></h4>
<p>Use <code>get_file_content_getter_fn()</code> for accessing file metadata and properties:</p>
<div class="highlight"><pre><span></span><code><span class="n">content_getter</span> <span class="o">=</span> <span class="n">get_file_content_getter_fn</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">company_id</span><span class="p">,</span> <span class="n">chat_id</span><span class="p">)</span>
<span class="n">content</span> <span class="o">=</span> <span class="n">content_getter</span><span class="p">(</span><span class="n">file_id</span><span class="p">)</span>

<span class="c1"># Access metadata</span>
<span class="k">if</span> <span class="n">content</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
    <span class="n">section</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;section&quot;</span><span class="p">)</span>
</code></pre></div>
<h4 id="file-upload-pattern">File Upload Pattern<a class="headerlink" href="#file-upload-pattern" title="Permanent link">&para;</a></h4>
<p>Use <code>get_uploader_fn()</code> for uploading generated artifacts:</p>
<div class="highlight"><pre><span></span><code><span class="n">uploader</span> <span class="o">=</span> <span class="n">get_uploader_fn</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">company_id</span><span class="p">,</span> <span class="n">chat_id</span><span class="p">)</span>
<span class="n">content</span> <span class="o">=</span> <span class="n">uploader</span><span class="p">(</span><span class="n">file_bytes</span><span class="p">,</span> <span class="n">mime_type</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</code></pre></div>
<h4 id="reference-creation-pattern">Reference Creation Pattern<a class="headerlink" href="#reference-creation-pattern" title="Permanent link">&para;</a></h4>
<p>Use <code>get_augmented_text_with_references_fn()</code> for creating clickable source links:</p>
<div class="highlight"><pre><span></span><code><span class="n">reference_builder</span> <span class="o">=</span> <span class="n">get_augmented_text_with_references_fn</span><span class="p">(</span>
    <span class="n">user_id</span><span class="p">,</span> <span class="n">company_id</span><span class="p">,</span> <span class="n">chat_id</span><span class="p">,</span> <span class="n">assistant_id</span>
<span class="p">)</span>

<span class="c1"># Create ID mapping for your content</span>
<span class="n">id_map</span> <span class="o">=</span> <span class="n">create_id_map</span><span class="p">(</span><span class="n">content_items</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;chunk&quot;</span><span class="p">)</span>

<span class="c1"># Convert citations to references</span>
<span class="n">augmented_text</span> <span class="o">=</span> <span class="n">reference_builder</span><span class="p">(</span>
    <span class="n">text_with_citations</span><span class="p">,</span>
    <span class="n">id_map</span><span class="p">,</span>
    <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;chunk&quot;</span><span class="p">,</span>
    <span class="n">citation_pattern</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;\[chunk_([a-zA-Z0-9\-]+)\]&quot;</span>
<span class="p">)</span>
</code></pre></div>
<p><strong>Key Benefits</strong>:
- Citations become clickable links in the UI
- Users can verify source information
- Creates audit trails for AI-generated content
- Improves transparency and trust</p>
<h3 id="flexibility-is-key">Flexibility is Key<a class="headerlink" href="#flexibility-is-key" title="Permanent link">&para;</a></h3>
<p>Remember that all handlers in this tutorial are <strong>examples</strong>. The framework provides events and tools - how you use them depends on your business requirements. You can integrate with any external system, use AI models, implement complex workflows, or create custom validation rules.</p>
<h2 id="summary-of-core-capabilities">Summary of Core Capabilities<a class="headerlink" href="#summary-of-core-capabilities" title="Permanent link">&para;</a></h2>
<p>This tutorial covered the essential building blocks for Agentic Table applications:</p>
<h3 id="event-handling">Event Handling<a class="headerlink" href="#event-handling" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>SHEET_CREATED</strong>: Initialize table structure with headers and styling</li>
<li><strong>ADD_META_DATA</strong>: Process uploaded files (questions and sources)</li>
<li><strong>UPDATE_CELL</strong>: React to user edits with business logic</li>
<li><strong>GENERATE_ARTIFACT</strong>: Export table data as documents</li>
<li><strong>SHEET_COMPLETED</strong>: Finalize and validate completed tables</li>
</ul>
<h3 id="data-operations">Data Operations<a class="headerlink" href="#data-operations" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Batch updates</strong>: Use <code>set_multiple_cells()</code> for performance</li>
<li><strong>Row operations</strong>: Read, update, and verify individual rows</li>
<li><strong>Status management</strong>: Communicate progress with <code>set_activity()</code></li>
<li><strong>Artifact linking</strong>: Connect generated files back to tables</li>
</ul>
<h3 id="file-management">File Management<a class="headerlink" href="#file-management" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Download files</strong>: Process CSV, Excel, and binary formats</li>
<li><strong>Retrieve content</strong>: Access file metadata and properties</li>
<li><strong>Upload artifacts</strong>: Create and link generated documents</li>
</ul>
<h3 id="advanced-capabilities">Advanced Capabilities<a class="headerlink" href="#advanced-capabilities" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Metadata filtering</strong>: Organize files by custom categories</li>
<li><strong>Reference creation</strong>: Convert citations to clickable links</li>
<li><strong>Content routing</strong>: Direct files to appropriate table rows</li>
<li><strong>Audit trails</strong>: Track provenance of data and decisions</li>
</ul>
<h3 id="integration-patterns">Integration Patterns<a class="headerlink" href="#integration-patterns" title="Permanent link">&para;</a></h3>
<p>All helper functions use the factory pattern with authentication context:
- Centralizes authentication logic
- Makes handlers testable
- Simplifies function signatures
- Enables dependency injection</p>
<p><strong>Key Takeaway</strong>: The framework provides the infrastructure (events, table operations, content management) while you implement the business logic (AI agents, validation rules, custom workflows).</p>
<h2 id="next-steps">Next Steps<a class="headerlink" href="#next-steps" title="Permanent link">&para;</a></h2>
<ul>
<li>Review the <a href="../../modules/agentic_table/">Agentic Table API Reference</a> for all available methods and schemas</li>
<li>Learn about <a href="../../application_types/event_driven/">Event-Driven Applications</a> for deployment options</li>
<li>Explore <a href="../../application_types/event_driven/event_driven_platform_setup/">platform setup</a> for configuring webhooks and ngrok</li>
</ul>
<details class="example">
<summary>Full Example Files (Click to expand)</summary>
<div class="tabbed-set tabbed-alternate" data-tabs="7:6"><input checked="checked" id="__tabbed_7_1" name="__tabbed_7" type="radio" /><input id="__tabbed_7_2" name="__tabbed_7" type="radio" /><input id="__tabbed_7_3" name="__tabbed_7" type="radio" /><input id="__tabbed_7_4" name="__tabbed_7" type="radio" /><input id="__tabbed_7_5" name="__tabbed_7" type="radio" /><input id="__tabbed_7_6" name="__tabbed_7" type="radio" /><div class="tabbed-labels"><label for="__tabbed_7_1">Complete FastAPI App</label><label for="__tabbed_7_2">Column Definitions</label><label for="__tabbed_7_3">Sheet Created Handler</label><label for="__tabbed_7_4">Metadata Added Handler</label><label for="__tabbed_7_5">Cell Updated Handler</label><label for="__tabbed_7_6">Artifact Generated Handler</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">unique_sdk.api_resources._agentic_table</span><span class="w"> </span><span class="kn">import</span> <span class="n">ActivityStatus</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">docs.examples_from_docs.agentic_table_example_artifact_generated_event_handler</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">handle_artifact_generated</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">docs.examples_from_docs.agentic_table_example_cell_updated_event_handler</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">handle_cell_updated</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">docs.examples_from_docs.agentic_table_example_metadata_added_event_handler</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">handle_metadata_added</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">docs.examples_from_docs.agentic_table_example_sheet_created_event_handler</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">handle_sheet_created</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">docs.examples_from_docs.agentic_table_helper_functions</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_augmented_text_with_references_fn</span><span class="p">,</span>
    <span class="n">get_downloader_fn</span><span class="p">,</span>
    <span class="n">get_file_content_getter_fn</span><span class="p">,</span>
    <span class="n">get_uploader_fn</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unique_toolkit.agentic_table.schemas</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">MagicTableAction</span><span class="p">,</span>
    <span class="n">MagicTableEvent</span><span class="p">,</span>
    <span class="n">MagicTableEventTypes</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unique_toolkit.agentic_table.service</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgenticTableService</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unique_toolkit.app.fast_api_factory</span><span class="w"> </span><span class="kn">import</span> <span class="n">build_unique_custom_app</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unique_toolkit.app.unique_settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">UniqueSettings</span>

<span class="c1"># Configure logging at module level so it works regardless of how the app is started</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
    <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
    <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> - </span><span class="si">%(name)s</span><span class="s2"> - </span><span class="si">%(levelname)s</span><span class="s2"> - </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="c1"># Default event handler</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">agentic_table_event_handler</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n">MagicTableEvent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Default event handler that serves as a controller for the Agentic Table.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Initialize Agentic Table Service to interact with agentic table.</span>
    <span class="n">at_service</span> <span class="o">=</span> <span class="n">AgenticTableService</span><span class="p">(</span>
        <span class="n">user_id</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
        <span class="n">company_id</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">company_id</span><span class="p">,</span>
        <span class="n">table_id</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">table_id</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Initialize the configuration from the event for your custom application</span>
    <span class="c1"># config = YourConfigClass.model_validate(event.payload.configuration)</span>

    <span class="c1"># You can now potentially use this configuration to initialize any other services needed for your application.</span>
    <span class="o">...</span>

    <span class="c1"># Register the agent</span>
    <span class="c1"># This locks the table from any modifications until the agent is completed.</span>
    <span class="c1"># Once registered the sheet status is shown as &quot;Updating&quot;</span>
    <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">register_agent</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># We use if-else statements here instead of match/case because it enables more precise typing and type narrowing for the payload based on the action (which functions as a discriminator).</span>
        <span class="c1"># Depending on the event received/action, run the corresponding functionality</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="n">MagicTableAction</span><span class="o">.</span><span class="n">SHEET_CREATED</span><span class="p">:</span>
            <span class="c1"># This event is triggered when a new sheet is created.</span>
            <span class="c1"># You can use this for housekeeping tasks like displaying the table headers, etc.</span>
            <span class="c1">#</span>
            <span class="c1"># Payload type (MagicTableSheetCreatedPayload):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sheet created: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">sheet_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Deregister the agent to unblock upcoming events</span>
            <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">deregister_agent</span><span class="p">()</span>

            <span class="c1"># Handle the sheet creation event (This is usally to setup the headers and column styles)</span>
            <span class="k">await</span> <span class="n">handle_sheet_created</span><span class="p">(</span><span class="n">at_service</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="p">)</span>

            <span class="c1"># In a standard workflow the user will select sources and a question file</span>
            <span class="c1"># This will trigger the add_metadata event and it can come quite quickly after the sheet_created event</span>
            <span class="c1"># therefore we need to deregister the agent to unblock the upcoming events</span>

        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="n">MagicTableAction</span><span class="o">.</span><span class="n">ADD_META_DATA</span><span class="p">:</span>
            <span class="c1"># This event is triggered when a new question or question file or source file is added.</span>
            <span class="c1">#</span>
            <span class="c1"># Payload type (MagicTableAddMetadataPayload):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Metadata added: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">metadata</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">downloader_fn</span> <span class="o">=</span> <span class="n">get_downloader_fn</span><span class="p">(</span>
                <span class="n">event</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">company_id</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">chat_id</span>
            <span class="p">)</span>
            <span class="n">file_content_getter_fn</span> <span class="o">=</span> <span class="n">get_file_content_getter_fn</span><span class="p">(</span>
                <span class="n">event</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">company_id</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">chat_id</span>
            <span class="p">)</span>
            <span class="n">augmented_text_with_references_fn</span> <span class="o">=</span> <span class="n">get_augmented_text_with_references_fn</span><span class="p">(</span>
                <span class="n">event</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">company_id</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">chat_id</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">assistant_id</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="n">handle_metadata_added</span><span class="p">(</span>
                <span class="n">at_service</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="p">,</span> <span class="n">downloader_fn</span><span class="p">,</span> <span class="n">file_content_getter_fn</span><span class="p">,</span> <span class="n">augmented_text_with_references_fn</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="n">MagicTableAction</span><span class="o">.</span><span class="n">UPDATE_CELL</span><span class="p">:</span>
            <span class="c1"># This event is triggered when a cell is updated.</span>
            <span class="c1">#</span>
            <span class="c1"># Payload type (MagicTableUpdateCellPayload):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cell updated: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">column_order</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">row_order</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="k">await</span> <span class="n">handle_cell_updated</span><span class="p">(</span><span class="n">at_service</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="n">MagicTableAction</span><span class="o">.</span><span class="n">GENERATE_ARTIFACT</span><span class="p">:</span>
            <span class="c1"># This event is triggered when a report generation button is clicked.</span>
            <span class="c1">#</span>
            <span class="c1"># Payload type (MagicTableGenerateArtifactPayload):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Artifact generated: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">uploader_fn</span> <span class="o">=</span> <span class="n">get_uploader_fn</span><span class="p">(</span>
                <span class="n">event</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">company_id</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">chat_id</span>
            <span class="p">)</span>

            <span class="k">await</span> <span class="n">handle_artifact_generated</span><span class="p">(</span><span class="n">at_service</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="p">,</span> <span class="n">uploader_fn</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="n">MagicTableAction</span><span class="o">.</span><span class="n">SHEET_COMPLETED</span><span class="p">:</span>
            <span class="c1"># This event is triggered when the sheet is marked as completed.</span>
            <span class="c1">#</span>
            <span class="c1"># Payload type (MagicTableSheetCompletedPayload):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sheet completed: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">sheet_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Here you can call a handler function that will handle the sheet completion event.</span>

        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="n">MagicTableAction</span><span class="o">.</span><span class="n">LIBRARY_SHEET_ROW_VERIFIED</span><span class="p">:</span>
            <span class="c1"># This event is triggered when a row in a &quot;Library&quot; sheet is verified.</span>
            <span class="c1"># This is a special sheet type and is only relevant within the context of Rfp Agent.</span>
            <span class="c1"># You can ignore this event/block if you are not working with the library feature.</span>
            <span class="c1">#</span>
            <span class="c1"># Payload type (MagicTableLibrarySheetRowVerifiedPayload):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Library sheet row verified: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">row_order</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Here you can call a handler function that will handle the library sheet row verified event.</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown action: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">set_activity</span><span class="p">(</span>
                <span class="n">activity</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="n">ActivityStatus</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span>
                <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Unknown action: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown action: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="mi">0</span>  <span class="c1"># Success</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in agentic table event handler: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">1</span>  <span class="c1"># Failure</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># De-register the agent</span>
        <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">deregister_agent</span><span class="p">()</span>


<span class="c1"># Create the default app instance at module level</span>
<span class="c1"># This MUST be at module level so uvicorn can find it when importing</span>

<span class="n">_SETTINGS</span> <span class="o">=</span> <span class="n">UniqueSettings</span><span class="o">.</span><span class="n">from_env</span><span class="p">(</span><span class="n">env_file</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;unique.env&quot;</span><span class="p">)</span>
<span class="n">_SETTINGS</span><span class="o">.</span><span class="n">init_sdk</span><span class="p">()</span>

<span class="c1"># Create app using factory</span>
<span class="n">_MINIMAL_APP</span> <span class="o">=</span> <span class="n">build_unique_custom_app</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Unique Minimal Agentic Table App&quot;</span><span class="p">,</span>
    <span class="n">settings</span><span class="o">=</span><span class="n">_SETTINGS</span><span class="p">,</span>
    <span class="n">event_handler</span><span class="o">=</span><span class="n">agentic_table_event_handler</span><span class="p">,</span>
    <span class="n">event_constructor</span><span class="o">=</span><span class="n">MagicTableEvent</span><span class="p">,</span>
    <span class="n">subscribed_event_names</span><span class="o">=</span><span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">MagicTableEventTypes</span><span class="p">],</span>
<span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

    <span class="kn">import</span><span class="w"> </span><span class="nn">uvicorn</span>

    <span class="c1"># Initialize settings</span>

    <span class="c1"># Enable debug logging</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
        <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
        <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> - </span><span class="si">%(name)s</span><span class="s2"> - </span><span class="si">%(levelname)s</span><span class="s2"> - </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Run the server</span>
    <span class="n">uvicorn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="s2">&quot;fastapi_app_agentic_table:_MINIMAL_APP&quot;</span><span class="p">,</span>
        <span class="n">host</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span>
        <span class="n">port</span><span class="o">=</span><span class="mi">5001</span><span class="p">,</span>
        <span class="n">reload</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">log_level</span><span class="o">=</span><span class="s2">&quot;debug&quot;</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">StrEnum</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unique_sdk</span><span class="w"> </span><span class="kn">import</span> <span class="n">CellRendererTypes</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ExampleColumnNames</span><span class="p">(</span><span class="n">StrEnum</span><span class="p">):</span>
    <span class="n">QUESTION</span> <span class="o">=</span> <span class="s2">&quot;Question&quot;</span>
    <span class="n">SECTION</span> <span class="o">=</span> <span class="s2">&quot;Section&quot;</span>
    <span class="n">ANSWER</span> <span class="o">=</span> <span class="s2">&quot;Answer&quot;</span>
    <span class="n">CRITICAL_CONSISTENCY</span> <span class="o">=</span> <span class="s2">&quot;Critical Consistency&quot;</span>
    <span class="n">STATUS</span> <span class="o">=</span> <span class="s2">&quot;Status&quot;</span>
    <span class="n">REVIEWER</span> <span class="o">=</span> <span class="s2">&quot;Reviewer&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ColumnDefinition</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Defines a single table column&#39;s structure and styling.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        order: Column position (0-indexed)</span>
<span class="sd">        name: Column header text</span>
<span class="sd">        width: Column width in pixels</span>
<span class="sd">        renderer: Optional cell renderer type (dropdown, checkbox, etc.)</span>
<span class="sd">        editable: Whether the column is editable</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">order</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">ExampleColumnNames</span>
    <span class="n">width</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">renderer</span><span class="p">:</span> <span class="n">CellRendererTypes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">editable</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ColumnDefinitions</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Container for all column definitions in the table.</span>

<span class="sd">    Provides helper methods to access columns by name.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ColumnDefinition</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">column_map</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ColumnDefinition</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Map of column names to their definitions.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">column</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">column</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_column_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ColumnDefinition</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get column definition by name.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_map</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_column_name_by_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExampleColumnNames</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get column definition by order.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">order</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_column_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get list of all column names.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>





<span class="n">example_configuration</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;columns&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">ExampleColumnNames</span><span class="o">.</span><span class="n">QUESTION</span><span class="p">,</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
            <span class="s2">&quot;renderer&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;editable&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">ExampleColumnNames</span><span class="o">.</span><span class="n">SECTION</span><span class="p">,</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">150</span><span class="p">,</span>
            <span class="s2">&quot;renderer&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;editable&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">ExampleColumnNames</span><span class="o">.</span><span class="n">ANSWER</span><span class="p">,</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>
            <span class="s2">&quot;renderer&quot;</span><span class="p">:</span> <span class="n">CellRendererTypes</span><span class="o">.</span><span class="n">SELECTABLE_CELL_RENDERER</span><span class="p">,</span>
            <span class="s2">&quot;editable&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">ExampleColumnNames</span><span class="o">.</span><span class="n">CRITICAL_CONSISTENCY</span><span class="p">,</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
            <span class="s2">&quot;renderer&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;editable&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">ExampleColumnNames</span><span class="o">.</span><span class="n">STATUS</span><span class="p">,</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">150</span><span class="p">,</span>
            <span class="s2">&quot;renderer&quot;</span><span class="p">:</span> <span class="n">CellRendererTypes</span><span class="o">.</span><span class="n">REVIEW_STATUS_DROPDOWN</span><span class="p">,</span>
            <span class="s2">&quot;editable&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">ExampleColumnNames</span><span class="o">.</span><span class="n">REVIEWER</span><span class="p">,</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">150</span><span class="p">,</span>
            <span class="s2">&quot;renderer&quot;</span><span class="p">:</span> <span class="n">CellRendererTypes</span><span class="o">.</span><span class="n">COLLABORATOR_DROPDOWN</span><span class="p">,</span>
            <span class="s2">&quot;editable&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">]</span>
<span class="p">}</span>

<span class="n">example_column_definitions</span> <span class="o">=</span> <span class="n">ColumnDefinitions</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span><span class="n">example_configuration</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">getLogger</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">unique_sdk.api_resources._agentic_table</span><span class="w"> </span><span class="kn">import</span> <span class="n">ActivityStatus</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">unique_toolkit.agentic_table.schemas</span><span class="w"> </span><span class="kn">import</span> <span class="n">MagicTableSheetCreatedPayload</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unique_toolkit.agentic_table.service</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgenticTableService</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.agentic_table_example_column_definition</span><span class="w"> </span><span class="kn">import</span> <span class="n">example_column_definitions</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_sheet_created</span><span class="p">(</span>
    <span class="n">at_service</span><span class="p">:</span> <span class="n">AgenticTableService</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">MagicTableSheetCreatedPayload</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Example handler for the sheet creation event.</span>

<span class="sd">    This demo shows how to initialize a new table by:</span>
<span class="sd">    - Setting column headers in row 0</span>
<span class="sd">    - Applying column styles (width, renderer type, editability)</span>

<span class="sd">    The table is ready to receive data after initialization.</span>

<span class="sd">    Args:</span>
<span class="sd">        at_service: Service instance for table operations</span>
<span class="sd">        payload: Event payload with table_id and sheet_name</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initializing Source of Wealth table: </span><span class="si">{</span><span class="n">payload</span><span class="o">.</span><span class="n">sheet_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Set activity status</span>
    <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">set_activity</span><span class="p">(</span>
        <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Initializing table schema...&quot;</span><span class="p">,</span>
        <span class="n">activity</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="n">ActivityStatus</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Set headers in row 0</span>
    <span class="k">for</span> <span class="n">col_def</span> <span class="ow">in</span> <span class="n">example_column_definitions</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">set_cell</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="n">col_def</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">col_def</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Set </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">example_column_definitions</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2"> column headers&quot;</span><span class="p">)</span>

    <span class="c1"># Apply column styles</span>
    <span class="k">for</span> <span class="n">col_def</span> <span class="ow">in</span> <span class="n">example_column_definitions</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">set_column_style</span><span class="p">(</span>
            <span class="n">column</span><span class="o">=</span><span class="n">col_def</span><span class="o">.</span><span class="n">order</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="n">col_def</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
            <span class="n">cell_renderer</span><span class="o">=</span><span class="n">col_def</span><span class="o">.</span><span class="n">renderer</span><span class="p">,</span>
            <span class="n">editable</span><span class="o">=</span><span class="n">col_def</span><span class="o">.</span><span class="n">editable</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Applied column styles with all CellRendererTypes&quot;</span><span class="p">)</span>

    <span class="c1"># Set completion status</span>
    <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">set_activity</span><span class="p">(</span>
        <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Table schema initialized successfully&quot;</span><span class="p">,</span>
        <span class="n">activity</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="n">ActivityStatus</span><span class="o">.</span><span class="n">COMPLETED</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">getLogger</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unique_sdk.api_resources._agentic_table</span><span class="w"> </span><span class="kn">import</span> <span class="n">ActivityStatus</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">unique_toolkit.agentic_table.schemas</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">MagicTableAddMetadataPayload</span><span class="p">,</span>
    <span class="n">MagicTableCell</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unique_toolkit.agentic_table.service</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgenticTableService</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unique_toolkit.content</span><span class="w"> </span><span class="kn">import</span> <span class="n">Content</span><span class="p">,</span> <span class="n">ContentChunk</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.agentic_table_example_column_definition</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">ExampleColumnNames</span><span class="p">,</span>
    <span class="n">example_column_definitions</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.agentic_table_helper_functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ContentRegistry</span><span class="p">,</span> <span class="n">create_id_map</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_question_files</span><span class="p">(</span>
    <span class="n">at_service</span><span class="p">:</span> <span class="n">AgenticTableService</span><span class="p">,</span>
    <span class="n">payload</span><span class="p">:</span> <span class="n">MagicTableAddMetadataPayload</span><span class="p">,</span>
    <span class="n">downloader_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">bytes</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handle question files by downloading and parsing CSV to populate the table.</span>

<span class="sd">    Args:</span>
<span class="sd">        at_service: Service instance for table operations</span>
<span class="sd">        payload: Event payload with metadata and file IDs</span>
<span class="sd">        downloader_fn: Function to download file contents</span>

<span class="sd">    Returns:</span>
<span class="sd">        Number of rows added to the table</span>

<span class="sd">    Raises:</span>
<span class="sd">        Exception: If CSV processing fails</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check if question files were provided</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">payload</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">question_file_ids</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No question files provided in metadata&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">set_activity</span><span class="p">(</span>
        <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Downloading CSV file...&quot;</span><span class="p">,</span>
        <span class="n">activity</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="n">ActivityStatus</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Get the first question file (CSV)</span>
    <span class="n">file_id</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">question_file_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading file: </span><span class="si">{</span><span class="n">file_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># Download file content</span>
    <span class="n">file_content</span> <span class="o">=</span> <span class="n">downloader_fn</span><span class="p">(</span><span class="n">file_id</span><span class="p">)</span>

    <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">set_activity</span><span class="p">(</span>
        <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Parsing CSV file...&quot;</span><span class="p">,</span>
        <span class="n">activity</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="n">ActivityStatus</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">file_content_stream</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">file_content</span><span class="p">)</span>

    <span class="c1"># Parse CSV file</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_content_stream</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># Convert NA values to empty strings</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parsed CSV with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2"> columns&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>

    <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">set_activity</span><span class="p">(</span>
        <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Populating table with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows...&quot;</span><span class="p">,</span>
        <span class="n">activity</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="n">ActivityStatus</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Create batch cells</span>
    <span class="n">cells</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">row_idx</span><span class="p">,</span> <span class="n">row_data</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">col_def</span> <span class="ow">in</span> <span class="n">example_column_definitions</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">cell_value</span> <span class="o">=</span> <span class="n">row_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">col_def</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cell_value</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">MagicTableCell</span><span class="p">(</span>
                    <span class="n">row_order</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">row_idx</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>
                    <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># +1 for header row</span>
                    <span class="n">column_order</span><span class="o">=</span><span class="n">col_def</span><span class="o">.</span><span class="n">order</span><span class="p">,</span>
                    <span class="n">text</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">cell_value</span><span class="p">),</span>
                    <span class="n">sheet_id</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">table_id</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cells</span><span class="p">)</span><span class="si">}</span><span class="s2"> cells for batch upload&quot;</span><span class="p">)</span>

    <span class="c1"># Batch upload all cells</span>
    <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">set_multiple_cells</span><span class="p">(</span><span class="n">cells</span><span class="o">=</span><span class="n">cells</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully populated table with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_source_files</span><span class="p">(</span>
    <span class="n">at_service</span><span class="p">:</span> <span class="n">AgenticTableService</span><span class="p">,</span>
    <span class="n">payload</span><span class="p">:</span> <span class="n">MagicTableAddMetadataPayload</span><span class="p">,</span>
    <span class="n">file_content_getter_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Content</span> <span class="o">|</span> <span class="kc">None</span><span class="p">],</span>
    <span class="n">augmented_text_with_references_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
        <span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Content</span> <span class="o">|</span> <span class="n">ContentChunk</span><span class="p">],</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">str</span>
    <span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handle source files by retrieving content and organizing by metadata.</span>

<span class="sd">    This handler demonstrates two key framework capabilities:</span>
<span class="sd">    1. Retrieving file content and accessing metadata</span>
<span class="sd">    2. Creating clickable references that link table cells to source documents</span>

<span class="sd">    The example shows:</span>
<span class="sd">    - How to fetch Content objects for uploaded files</span>
<span class="sd">    - How to use ContentRegistry to group files by metadata keys</span>
<span class="sd">    - How to generate text with inline citations and convert them to clickable references</span>
<span class="sd">    - How to populate table cells with referenced content</span>

<span class="sd">    Args:</span>
<span class="sd">        at_service: Service instance for table operations</span>
<span class="sd">        payload: Event payload with metadata and file IDs</span>
<span class="sd">        file_content_getter_fn: Function to retrieve file content objects</span>
<span class="sd">        augmented_text_with_references_fn: Function to convert citations to references</span>

<span class="sd">    Returns:</span>
<span class="sd">        Number of content items processed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check if source files were provided</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">payload</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">source_file_ids</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No source files provided in metadata&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">set_activity</span><span class="p">(</span>
        <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Processing source files metadata...&quot;</span><span class="p">,</span>
        <span class="n">activity</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="n">ActivityStatus</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">cells_to_update</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">MagicTableCell</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">num_rows</span> <span class="o">=</span> <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">get_num_rows</span><span class="p">()</span>

    <span class="c1"># STEP 1: Retrieve Content objects for all source files</span>
    <span class="c1"># Each Content object contains:</span>
    <span class="c1"># - content.id: Unique identifier</span>
    <span class="c1"># - content.metadata: Custom key-value pairs (e.g., {&quot;section&quot;: &quot;Finance&quot;})</span>
    <span class="c1"># - content.title: File name or title</span>
    <span class="c1"># - content.text: Extracted text content</span>
    <span class="c1"># - content.chunks: List of ContentChunk objects for chunked documents</span>
    <span class="n">all_contents</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">file_id</span> <span class="ow">in</span> <span class="n">payload</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">source_file_ids</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">file_content_getter_fn</span><span class="p">(</span><span class="n">file_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No content found for file: </span><span class="si">{</span><span class="n">file_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">content</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No metadata found for file: </span><span class="si">{</span><span class="n">file_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">all_contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

    <span class="c1"># STEP 2: Organize content by metadata keys</span>
    <span class="c1"># This example assumes source files have metadata like:</span>
    <span class="c1"># {&quot;Team&quot;: &quot;true&quot;}, {&quot;Finance&quot;: &quot;true&quot;}, {&quot;Technical&quot;: &quot;true&quot;}, etc.</span>
    <span class="n">sections_of_interest</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;Team&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Finance&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Technical&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Planning&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="c1"># ContentRegistry groups files by metadata keys</span>
    <span class="c1"># You can later retrieve all files tagged with &quot;Finance&quot;, &quot;Team&quot;, etc.</span>
    <span class="n">content_registry</span> <span class="o">=</span> <span class="n">ContentRegistry</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="n">sections_of_interest</span><span class="p">,</span> <span class="n">contents</span><span class="o">=</span><span class="n">all_contents</span><span class="p">)</span>

    <span class="c1"># STEP 3: Process each row in the table</span>
    <span class="c1"># This demonstrates row-by-row processing where each row might need different source files</span>
    <span class="k">for</span> <span class="n">row_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_rows</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="c1"># Retrieve the current row to check what data it has</span>
        <span class="n">row_cells</span> <span class="o">=</span> <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">get_sheet</span><span class="p">(</span>
            <span class="n">start_row</span><span class="o">=</span><span class="n">row_index</span><span class="p">,</span> <span class="n">end_row</span><span class="o">=</span><span class="n">row_index</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">)</span>
        <span class="n">retrieved_cells</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">ExampleColumnNames</span><span class="p">,</span> <span class="n">MagicTableCell</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">example_column_definitions</span><span class="o">.</span><span class="n">get_column_name_by_order</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">column_order</span><span class="p">):</span> <span class="n">cell</span>
            <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">row_cells</span><span class="o">.</span><span class="n">magic_table_cells</span>
        <span class="p">}</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retrieved cells: </span><span class="si">{</span><span class="n">retrieved_cells</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">answer_cell</span> <span class="o">=</span> <span class="n">retrieved_cells</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ExampleColumnNames</span><span class="o">.</span><span class="n">ANSWER</span><span class="p">)</span>

        <span class="c1"># Check if the answer cell exists. This means that the answer was already generated.</span>
        <span class="k">if</span> <span class="n">answer_cell</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Answer found for row </span><span class="si">{</span><span class="n">row_index</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">answer_cell</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Get the section for this row (e.g., &quot;Finance&quot;, &quot;Team&quot;)</span>
            <span class="n">section_name</span> <span class="o">=</span> <span class="n">retrieved_cells</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ExampleColumnNames</span><span class="o">.</span><span class="n">SECTION</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">section_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No section found for row </span><span class="si">{</span><span class="n">row_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># STEP 4: Retrieve relevant content based on row metadata</span>
            <span class="c1"># Use the ContentRegistry to get all files tagged with this section</span>
            <span class="n">relevant_contents</span> <span class="o">=</span> <span class="n">content_registry</span><span class="o">.</span><span class="n">get_contents_by_metadata_key</span><span class="p">(</span>
                <span class="n">section_name</span><span class="o">.</span><span class="n">text</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">relevant_contents</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No contents found for section &#39;</span><span class="si">{</span><span class="n">section_name</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">relevant_contents</span><span class="p">)</span><span class="si">}</span><span class="s2"> content items for section &#39;</span><span class="si">{</span><span class="n">section_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            <span class="p">)</span>

            <span class="c1"># STEP 5: Create a reference registry for citation mapping</span>
            <span class="c1"># This creates temporary IDs like &quot;chunk_a1b2c3d4&quot; for each content item</span>
            <span class="c1"># These IDs will be used in inline citations: [chunk_a1b2c3d4]</span>
            <span class="n">chunk_prefix</span> <span class="o">=</span> <span class="s2">&quot;chunk&quot;</span>
            <span class="n">reference_registry</span> <span class="o">=</span> <span class="n">create_id_map</span><span class="p">(</span><span class="n">relevant_contents</span><span class="p">,</span> <span class="n">chunk_prefix</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reference registry: </span><span class="si">{</span><span class="n">reference_registry</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># STEP 6: Generate text with inline citations</span>
            <span class="c1"># In a real application, this would be AI-generated text with citations</span>
            <span class="c1"># Here we simulate it by listing the content titles with citation markers</span>
            <span class="n">simulated_text_generation_with_references</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;The following are the contents of the section: </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">chunk_id</span><span class="p">,</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">reference_registry</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Add inline citation in format [chunk_xxx]</span>
                <span class="n">simulated_text_generation_with_references</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">content</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">chunk_id</span><span class="si">}</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="c1"># STEP 7: Convert inline citations to clickable references</span>
            <span class="c1"># This transforms [chunk_a1b2c3d4] into numbered references like [1], [2]</span>
            <span class="c1"># The frontend will render these as clickable links to the source files</span>
            <span class="n">augmented_text</span> <span class="o">=</span> <span class="n">augmented_text_with_references_fn</span><span class="p">(</span>
                <span class="n">simulated_text_generation_with_references</span><span class="p">,</span>
                <span class="n">reference_registry</span><span class="p">,</span>  <span class="c1"># type: ignore[arg-type]</span>
                <span class="n">chunk_prefix</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;\[chunk_([a-zA-Z0-9\-]+)\]&quot;</span><span class="p">,</span>  <span class="c1"># Citation pattern to match</span>
            <span class="p">)</span>

            <span class="c1"># STEP 8: Update the table cell with referenced text</span>
            <span class="n">cells_to_update</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">MagicTableCell</span><span class="p">(</span>
                    <span class="n">row_order</span><span class="o">=</span><span class="n">row_index</span><span class="p">,</span>
                    <span class="n">column_order</span><span class="o">=</span><span class="n">example_column_definitions</span><span class="o">.</span><span class="n">get_column_by_name</span><span class="p">(</span>
                        <span class="n">ExampleColumnNames</span><span class="o">.</span><span class="n">ANSWER</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">order</span><span class="p">,</span>
                    <span class="n">text</span><span class="o">=</span><span class="n">augmented_text</span><span class="p">,</span>
                    <span class="n">sheet_id</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">table_id</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="c1"># Apply any cell updates</span>
    <span class="k">if</span> <span class="n">cells_to_update</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">set_multiple_cells</span><span class="p">(</span><span class="n">cells</span><span class="o">=</span><span class="n">cells_to_update</span><span class="p">)</span>

    <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">set_activity</span><span class="p">(</span>
        <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Successfully processed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_contents</span><span class="p">)</span><span class="si">}</span><span class="s2"> source files&quot;</span><span class="p">,</span>
        <span class="n">activity</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="n">ActivityStatus</span><span class="o">.</span><span class="n">COMPLETED</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_contents</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_metadata_added</span><span class="p">(</span>
    <span class="n">at_service</span><span class="p">:</span> <span class="n">AgenticTableService</span><span class="p">,</span>
    <span class="n">payload</span><span class="p">:</span> <span class="n">MagicTableAddMetadataPayload</span><span class="p">,</span>
    <span class="n">downloader_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">bytes</span><span class="p">],</span>
    <span class="n">file_content_getter_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Content</span> <span class="o">|</span> <span class="kc">None</span><span class="p">],</span>
    <span class="n">augmented_text_with_references_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
        <span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Content</span> <span class="o">|</span> <span class="n">ContentChunk</span><span class="p">],</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">str</span>
    <span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Example handler for the metadata addition event.</span>

<span class="sd">    This demo shows how to populate a table from uploaded files:</span>
<span class="sd">    - Process question files: Downloads CSV files and populates the table</span>
<span class="sd">    - Process source files: Retrieves content and groups by metadata</span>

<span class="sd">    Args:</span>
<span class="sd">        at_service: Service instance for table operations</span>
<span class="sd">        payload: Event payload with metadata and file IDs</span>
<span class="sd">        downloader_fn: Function to download file contents</span>
<span class="sd">        file_content_getter_fn: Function to retrieve file content objects</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing metadata for sheet: </span><span class="si">{</span><span class="n">payload</span><span class="o">.</span><span class="n">sheet_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Handle question files (CSV processing)</span>
        <span class="n">num_question_rows</span> <span class="o">=</span> <span class="k">await</span> <span class="n">handle_question_files</span><span class="p">(</span>
            <span class="n">at_service</span><span class="o">=</span><span class="n">at_service</span><span class="p">,</span>
            <span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span>
            <span class="n">downloader_fn</span><span class="o">=</span><span class="n">downloader_fn</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Handle source files (content and metadata processing)</span>
        <span class="n">num_source_rows</span> <span class="o">=</span> <span class="k">await</span> <span class="n">handle_source_files</span><span class="p">(</span>
            <span class="n">at_service</span><span class="o">=</span><span class="n">at_service</span><span class="p">,</span>
            <span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span>
            <span class="n">file_content_getter_fn</span><span class="o">=</span><span class="n">file_content_getter_fn</span><span class="p">,</span>
            <span class="n">augmented_text_with_references_fn</span><span class="o">=</span><span class="n">augmented_text_with_references_fn</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># This is different from the LogEntry which shows in the cell history</span>
        <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">set_activity</span><span class="p">(</span>
            <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Successfully loaded </span><span class="si">{</span><span class="n">num_question_rows</span><span class="si">}</span><span class="s2"> rows from CSV and </span><span class="si">{</span><span class="n">num_source_rows</span><span class="si">}</span><span class="s2"> source file metadata rows&quot;</span><span class="p">,</span>
            <span class="n">activity</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="n">ActivityStatus</span><span class="o">.</span><span class="n">COMPLETED</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing files: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">set_activity</span><span class="p">(</span>
            <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Failed to process files: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">activity</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="n">ActivityStatus</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">raise</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">unique_toolkit.agentic_table.schemas</span><span class="w"> </span><span class="kn">import</span> <span class="n">MagicTableUpdateCellPayload</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unique_toolkit.agentic_table.service</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgenticTableService</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">getLogger</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unique_toolkit.language_model.schemas</span><span class="w"> </span><span class="kn">import</span> <span class="n">LanguageModelMessageRole</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unique_sdk</span><span class="w"> </span><span class="kn">import</span> <span class="n">RowVerificationStatus</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unique_toolkit.agentic_table.schemas</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogEntry</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.agentic_table_example_column_definition</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">example_column_definitions</span><span class="p">,</span>
    <span class="n">ExampleColumnNames</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_cell_updated</span><span class="p">(</span>
    <span class="n">at_service</span><span class="p">:</span> <span class="n">AgenticTableService</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">MagicTableUpdateCellPayload</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Example handler for the cell update event.</span>

<span class="sd">    This demo shows a simple workflow automation: when the Critical Consistency column</span>
<span class="sd">    changes to &quot;Consistent&quot;, it adds a log entry and updates</span>
<span class="sd">    the row verification status.</span>

<span class="sd">    Args:</span>
<span class="sd">        at_service: Service instance for table operations</span>
<span class="sd">        payload: Event payload with row, column, and new value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Cell updated at row </span><span class="si">{</span><span class="n">payload</span><span class="o">.</span><span class="n">row_order</span><span class="si">}</span><span class="s2">, &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;column </span><span class="si">{</span><span class="n">payload</span><span class="o">.</span><span class="n">column_order</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">payload</span><span class="o">.</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="n">critical_consistency_col</span> <span class="o">=</span> <span class="n">example_column_definitions</span><span class="o">.</span><span class="n">get_column_by_name</span><span class="p">(</span>
        <span class="n">ExampleColumnNames</span><span class="o">.</span><span class="n">CRITICAL_CONSISTENCY</span>
    <span class="p">)</span>

    <span class="c1"># Check if the Critical Consistency column was updated</span>
    <span class="k">if</span> <span class="n">payload</span><span class="o">.</span><span class="n">column_order</span> <span class="o">==</span> <span class="n">critical_consistency_col</span><span class="o">.</span><span class="n">order</span><span class="p">:</span>
        <span class="n">status_value</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Status changed to: </span><span class="si">{</span><span class="n">status_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Check if status is Completed or Verified (lock row)</span>
        <span class="k">if</span> <span class="n">status_value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;consistent&quot;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Locking row </span><span class="si">{</span><span class="n">payload</span><span class="o">.</span><span class="n">row_order</span><span class="si">}</span><span class="s2"> due to status: </span><span class="si">{</span><span class="n">status_value</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Note: Column-level locking affects all rows. In a production system,</span>
            <span class="c1"># you might track locked rows in metadata and validate edits server-side.</span>
            <span class="c1"># Here we demonstrate the pattern with a log entry.</span>

            <span class="c1"># Add log entry to document the status change and locking</span>
            <span class="n">log_entries</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">LogEntry</span><span class="p">(</span>
                    <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Row </span><span class="si">{</span><span class="n">payload</span><span class="o">.</span><span class="n">row_order</span><span class="si">}</span><span class="s2"> marked as </span><span class="si">{</span><span class="n">status_value</span><span class="si">}</span><span class="s2">. Further edits should be restricted.&quot;</span><span class="p">,</span>
                    <span class="n">created_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                    <span class="n">actor_type</span><span class="o">=</span><span class="n">LanguageModelMessageRole</span><span class="o">.</span><span class="n">ASSISTANT</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">]</span>

            <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">set_cell</span><span class="p">(</span>
                <span class="n">row</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">row_order</span><span class="p">,</span>
                <span class="n">column</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">column_order</span><span class="p">,</span>
                <span class="n">text</span><span class="o">=</span><span class="n">status_value</span><span class="p">,</span>
                <span class="n">log_entries</span><span class="o">=</span><span class="n">log_entries</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Update row verification status</span>
            <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">update_row_verification_status</span><span class="p">(</span>
                <span class="n">row_orders</span><span class="o">=</span><span class="p">[</span><span class="n">payload</span><span class="o">.</span><span class="n">row_order</span><span class="p">],</span> <span class="n">status</span><span class="o">=</span><span class="n">RowVerificationStatus</span><span class="o">.</span><span class="n">VERIFIED</span>
            <span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Row </span><span class="si">{</span><span class="n">payload</span><span class="o">.</span><span class="n">row_order</span><span class="si">}</span><span class="s2"> verified and logged&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">getLogger</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">unique_sdk.api_resources._agentic_table</span><span class="w"> </span><span class="kn">import</span> <span class="n">ActivityStatus</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">unique_toolkit._common.docx_generator</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">DocxGeneratorConfig</span><span class="p">,</span>
    <span class="n">DocxGeneratorService</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unique_toolkit.agentic_table.schemas</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">MagicTableGenerateArtifactPayload</span><span class="p">,</span>
    <span class="n">MagicTableSheet</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unique_toolkit.agentic_table.service</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgenticTableService</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unique_toolkit.content.schemas</span><span class="w"> </span><span class="kn">import</span> <span class="n">Content</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.agentic_table_example_column_definition</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">ExampleColumnNames</span><span class="p">,</span>
    <span class="n">example_column_definitions</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_artifact_generated</span><span class="p">(</span>
    <span class="n">at_service</span><span class="p">:</span> <span class="n">AgenticTableService</span><span class="p">,</span>
    <span class="n">payload</span><span class="p">:</span> <span class="n">MagicTableGenerateArtifactPayload</span><span class="p">,</span>
    <span class="n">uploader_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">Content</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Example handler for the artifact generation event.</span>

<span class="sd">    This demo shows how to export table data as a Word document:</span>
<span class="sd">    - Fetches all table data</span>
<span class="sd">    - Organizes it by sections</span>
<span class="sd">    - Generates a markdown report</span>
<span class="sd">    - Converts to DOCX and uploads it</span>
<span class="sd">    - Links the artifact back to the table</span>

<span class="sd">    Args:</span>
<span class="sd">        at_service: Service instance for table operations</span>
<span class="sd">        payload: Event payload with artifact type</span>
<span class="sd">        uploader_fn: Function to upload the generated file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating artifact of type: </span><span class="si">{</span><span class="n">payload</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">artifact_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">set_activity</span><span class="p">(</span>
        <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Starting report generation...&quot;</span><span class="p">,</span>
        <span class="n">activity</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="n">ActivityStatus</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Read and organize data</span>
        <span class="n">sheet</span> <span class="o">=</span> <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">get_sheet</span><span class="p">(</span><span class="n">start_row</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">end_row</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">rows_data</span> <span class="o">=</span> <span class="n">organize_sheet_data</span><span class="p">(</span><span class="n">sheet</span><span class="p">)</span>

        <span class="c1"># Build markdown report</span>
        <span class="n">markdown</span> <span class="o">=</span> <span class="n">build_markdown_report</span><span class="p">(</span><span class="n">rows_data</span><span class="p">)</span>

        <span class="c1"># Generate DOCX</span>
        <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">set_activity</span><span class="p">(</span>
            <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Generating document...&quot;</span><span class="p">,</span>
            <span class="n">activity</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="n">ActivityStatus</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">docx_generator</span> <span class="o">=</span> <span class="n">DocxGeneratorService</span><span class="p">(</span>
            <span class="n">config</span><span class="o">=</span><span class="n">DocxGeneratorConfig</span><span class="p">(</span>
                <span class="n">template_content_id</span><span class="o">=</span><span class="s2">&quot;content-template-generic&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">content_fields</span> <span class="o">=</span> <span class="n">docx_generator</span><span class="o">.</span><span class="n">parse_markdown_to_list_content_fields</span><span class="p">(</span><span class="n">markdown</span><span class="p">)</span>
        <span class="n">docx_file</span> <span class="o">=</span> <span class="n">docx_generator</span><span class="o">.</span><span class="n">generate_from_template</span><span class="p">(</span><span class="n">content_fields</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">docx_file</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to generate DOCX file&quot;</span><span class="p">)</span>

        <span class="c1"># Upload to chat</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Table_Report_</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">.docx&quot;</span>

        <span class="n">content</span> <span class="o">=</span> <span class="n">uploader_fn</span><span class="p">(</span>
            <span class="n">docx_file</span><span class="p">,</span>
            <span class="s2">&quot;application/vnd.openxmlformats-officedocument.wordprocessingml.document&quot;</span><span class="p">,</span>
            <span class="n">filename</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Set artifact reference</span>
        <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">set_artifact</span><span class="p">(</span>
            <span class="n">artifact_type</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">artifact_type</span><span class="p">,</span>
            <span class="n">content_id</span><span class="o">=</span><span class="n">content</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">mime_type</span><span class="o">=</span><span class="s2">&quot;application/vnd.openxmlformats-officedocument.wordprocessingml.document&quot;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">set_activity</span><span class="p">(</span>
            <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Report generated successfully: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">activity</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="n">ActivityStatus</span><span class="o">.</span><span class="n">COMPLETED</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error generating artifact: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">at_service</span><span class="o">.</span><span class="n">set_activity</span><span class="p">(</span>
            <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Report generation failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">activity</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="n">ActivityStatus</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">raise</span>


<span class="k">def</span><span class="w"> </span><span class="nf">organize_sheet_data</span><span class="p">(</span><span class="n">sheet</span><span class="p">:</span> <span class="n">MagicTableSheet</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert flat cell list to nested dictionary structure.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with structure {row_order: {column_order: cell_text}}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rows_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">sheet</span><span class="o">.</span><span class="n">magic_table_cells</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cell</span><span class="o">.</span><span class="n">row_order</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rows_data</span><span class="p">:</span>
            <span class="n">rows_data</span><span class="p">[</span><span class="n">cell</span><span class="o">.</span><span class="n">row_order</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">rows_data</span><span class="p">[</span><span class="n">cell</span><span class="o">.</span><span class="n">row_order</span><span class="p">][</span><span class="n">cell</span><span class="o">.</span><span class="n">column_order</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">text</span>

    <span class="k">return</span> <span class="n">rows_data</span>


<span class="k">def</span><span class="w"> </span><span class="nf">build_markdown_report</span><span class="p">(</span><span class="n">rows_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a markdown report grouped by sections.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Markdown string with sections and question details</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">markdown_lines</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;# Table Report&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;**Generated:** </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;---&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="c1"># Get column indices</span>
    <span class="n">question_col</span> <span class="o">=</span> <span class="n">example_column_definitions</span><span class="o">.</span><span class="n">get_column_by_name</span><span class="p">(</span>
        <span class="n">ExampleColumnNames</span><span class="o">.</span><span class="n">QUESTION</span>
    <span class="p">)</span><span class="o">.</span><span class="n">order</span>
    <span class="n">section_col</span> <span class="o">=</span> <span class="n">example_column_definitions</span><span class="o">.</span><span class="n">get_column_by_name</span><span class="p">(</span>
        <span class="n">ExampleColumnNames</span><span class="o">.</span><span class="n">SECTION</span>
    <span class="p">)</span><span class="o">.</span><span class="n">order</span>
    <span class="n">answer_col</span> <span class="o">=</span> <span class="n">example_column_definitions</span><span class="o">.</span><span class="n">get_column_by_name</span><span class="p">(</span>
        <span class="n">ExampleColumnNames</span><span class="o">.</span><span class="n">ANSWER</span>
    <span class="p">)</span><span class="o">.</span><span class="n">order</span>
    <span class="n">consistency_col</span> <span class="o">=</span> <span class="n">example_column_definitions</span><span class="o">.</span><span class="n">get_column_by_name</span><span class="p">(</span>
        <span class="n">ExampleColumnNames</span><span class="o">.</span><span class="n">CRITICAL_CONSISTENCY</span>
    <span class="p">)</span><span class="o">.</span><span class="n">order</span>
    <span class="n">status_col</span> <span class="o">=</span> <span class="n">example_column_definitions</span><span class="o">.</span><span class="n">get_column_by_name</span><span class="p">(</span>
        <span class="n">ExampleColumnNames</span><span class="o">.</span><span class="n">STATUS</span>
    <span class="p">)</span><span class="o">.</span><span class="n">order</span>
    <span class="n">reviewer_col</span> <span class="o">=</span> <span class="n">example_column_definitions</span><span class="o">.</span><span class="n">get_column_by_name</span><span class="p">(</span>
        <span class="n">ExampleColumnNames</span><span class="o">.</span><span class="n">REVIEWER</span>
    <span class="p">)</span><span class="o">.</span><span class="n">order</span>

    <span class="c1"># Get data rows (excluding header row 0)</span>
    <span class="n">data_rows</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rows_data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">}</span>

    <span class="c1"># Group by section</span>
    <span class="n">sections</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">row_data</span> <span class="ow">in</span> <span class="n">data_rows</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">section</span> <span class="o">=</span> <span class="n">row_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section_col</span><span class="p">,</span> <span class="s2">&quot;General&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">section</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sections</span><span class="p">:</span>
            <span class="n">sections</span><span class="p">[</span><span class="n">section</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sections</span><span class="p">[</span><span class="n">section</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row_data</span><span class="p">)</span>

    <span class="c1"># Add each section</span>
    <span class="k">for</span> <span class="n">section_name</span><span class="p">,</span> <span class="n">section_rows</span> <span class="ow">in</span> <span class="n">sections</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">markdown_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="sa">f</span><span class="s2">&quot;## </span><span class="si">{</span><span class="n">section_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">row_data</span> <span class="ow">in</span> <span class="n">section_rows</span><span class="p">:</span>
            <span class="n">question</span> <span class="o">=</span> <span class="n">row_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">question_col</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">)</span>
            <span class="n">answer</span> <span class="o">=</span> <span class="n">row_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">answer_col</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">)</span>
            <span class="n">consistency</span> <span class="o">=</span> <span class="n">row_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">consistency_col</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">)</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">row_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">status_col</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">)</span>
            <span class="n">reviewer</span> <span class="o">=</span> <span class="n">row_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">reviewer_col</span><span class="p">,</span> <span class="s2">&quot;Unassigned&quot;</span><span class="p">)</span>

            <span class="n">markdown_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="sa">f</span><span class="s2">&quot;**Question:** </span><span class="si">{</span><span class="n">question</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;**Answer:** </span><span class="si">{</span><span class="n">answer</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;**Consistency:** </span><span class="si">{</span><span class="n">consistency</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;**Status:** </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;**Reviewer:** </span><span class="si">{</span><span class="n">reviewer</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;---&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">markdown_lines</span><span class="p">)</span>
</code></pre></div>
</div>
</div>
</div>
</details></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>
        <script src="../../js/version-select.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
