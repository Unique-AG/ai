name: "[type-check] Unique Toolkit"

env:
  PACKAGE: unique_toolkit

on: 
  pull_request:
    paths:
      - 'unique_toolkit/**'
      - '!unique_toolkit/docs/**'
      - '!unique_toolkit/**/docs/**'
      - '!unique_toolkit/mkdocs.yaml'
      - '!unique_toolkit/docs.subproject.mkdocs.yaml'
      - '!unique_toolkit/.entangled/**'

jobs:
  type-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
    - name: Check out code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need full history for diff comparison

    - name: Setup Python and Poetry
      uses: ./.github/actions/setup-python-poetry

    - name: Install dependencies
      working-directory: ${{ env.PACKAGE }}
      run: poetry install

    - name: Install reviewdog
      run: |
        curl -sfL https://raw.githubusercontent.com/reviewdog/reviewdog/master/install.sh | sh -s -- -b /tmp

    - name: Fetch base branch for comparison
      run: git fetch origin ${{ github.base_ref }}:${{ github.base_ref }}

    - name: Create baseline from base branch
      working-directory: ${{ env.PACKAGE }}
      run: |
        bash ${{ github.workspace }}/.github/scripts/create-type-baseline.sh ${{ github.workspace }}/${{ env.PACKAGE }} ${{ github.base_ref }} --ci

    - name: Apply baseline to PR branch
      working-directory: ${{ env.PACKAGE }}
      run: |
        bash ${{ github.workspace }}/.github/scripts/apply-type-baseline.sh ${{ github.workspace }}/${{ env.PACKAGE }} /tmp/baseline.json ${{ github.base_ref }}

    - name: Run basedpyright
      working-directory: ${{ env.PACKAGE }}
      run: |
        bash ${{ github.workspace }}/.github/scripts/run-basedpyright.sh ${{ github.workspace }}/${{ env.PACKAGE }} /tmp/basedpyright.json

    - name: Report type errors
      env:
        REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        bash ${{ github.workspace }}/.github/scripts/report-type-errors.sh \
          ${{ github.workspace }}/${{ env.PACKAGE }} \
          /tmp/basedpyright.json \
          --reviewdog /tmp/reviewdog \
          --base-ref ${{ github.base_ref }}

