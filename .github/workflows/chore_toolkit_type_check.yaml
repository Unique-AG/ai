name: "[type-check] Unique Toolkit"

env:
  PACKAGE: unique_toolkit

on: 
  pull_request:
    # paths:
    #   - 'unique_toolkit/**'
    #   - '!unique_toolkit/docs/**'
    #   - '!unique_toolkit/**/docs/**'
    #   - '!unique_toolkit/mkdocs.yaml'
    #   - '!unique_toolkit/docs.subproject.mkdocs.yaml'
    #   - '!unique_toolkit/.entangled/**'

jobs:
  type-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
    - name: Check out code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need full history for diff comparison

    - name: Setup Python and Poetry
      uses: ./.github/actions/setup-python-poetry

    - name: Install dependencies
      working-directory: ${{ env.PACKAGE }}
      run: poetry install

    - name: Install basedpyright
      working-directory: ${{ env.PACKAGE }}
      run: |
        # Install basedpyright if not already available
        if ! poetry run basedpyright --version 2>/dev/null; then
          poetry run pip install basedpyright
        fi

    - name: Install reviewdog
      run: |
        curl -sfL https://raw.githubusercontent.com/reviewdog/reviewdog/master/install.sh | sh -s -- -b /tmp
        /tmp/reviewdog -version

    - name: Fetch base branch for comparison
      run: |
        git fetch origin ${{ github.base_ref }}:${{ github.base_ref }}

    - name: Run basedpyright and post review comments
      working-directory: ${{ env.PACKAGE }}
      env:
        REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Run basedpyright which uses the baseline.json to only report new errors
        # basedpyright outputs in pyright format: file:line:column - message
        # Use reviewdog to post comments only on changed lines in the PR
        set +e  # Don't fail on basedpyright errors, let reviewdog handle it
        
        poetry run basedpyright --outputformat text 2>&1 | \
          /tmp/reviewdog \
            -f=pyright \
            -reporter=github-pr-review \
            -fail-on-error=false \
            -filter-mode=diff_context \
            -diff="git diff origin/${{ github.base_ref }}"
        
        # Exit with success even if there are type errors (they're posted as comments)
        exit 0

