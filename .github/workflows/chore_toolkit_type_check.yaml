name: "[type-check] Unique Toolkit"

env:
  PACKAGE: unique_toolkit

on: 
  pull_request:
    # paths:
    #   - 'unique_toolkit/**'
    #   - '!unique_toolkit/docs/**'
    #   - '!unique_toolkit/**/docs/**'
    #   - '!unique_toolkit/mkdocs.yaml'
    #   - '!unique_toolkit/docs.subproject.mkdocs.yaml'
    #   - '!unique_toolkit/.entangled/**'

jobs:
  type-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
    - name: Check out code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need full history for diff comparison

    - name: Setup Python and Poetry
      uses: ./.github/actions/setup-python-poetry

    - name: Install dependencies
      working-directory: ${{ env.PACKAGE }}
      run: poetry install

    - name: Install reviewdog
      run: |
        curl -sfL https://raw.githubusercontent.com/reviewdog/reviewdog/master/install.sh | sh -s -- -b /tmp

    - name: Fetch base branch for comparison
      run: git fetch origin ${{ github.base_ref }}:${{ github.base_ref }}

    - name: Run basedpyright and post review comments
      working-directory: ${{ env.PACKAGE }}
      env:
        REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        set +e  # Don't fail on basedpyright errors
        
        # Store repo root (we're in package directory, so go up one level)
        REPO_ROOT=$(cd .. && pwd)
        
        # Debug: Check if basedpyright is available
        echo "=== Checking basedpyright installation ==="
        poetry show basedpyright || echo "WARNING: basedpyright not found in poetry dependencies"
        poetry run which basedpyright || echo "WARNING: basedpyright not in PATH"
        echo ""
        
        # Run basedpyright from package directory and capture output
        echo "=== Running basedpyright ==="
        poetry run basedpyright 2>&1 | tee /tmp/basedpyright_output.txt || {
          EXIT_CODE=$?
          echo "ERROR: basedpyright failed with exit code $EXIT_CODE"
          echo "Output:"
          cat /tmp/basedpyright_output.txt || echo "No output captured"
          # Don't exit - continue to check if we got any output
        }
        
        # Check if we got any output
        if [ ! -f /tmp/basedpyright_output.txt ] || [ ! -s /tmp/basedpyright_output.txt ]; then
          echo "ERROR: basedpyright output file is empty or not created"
          echo "File exists: $([ -f /tmp/basedpyright_output.txt ] && echo 'yes' || echo 'no')"
          echo "File size: $(wc -c < /tmp/basedpyright_output.txt 2>/dev/null || echo '0') bytes"
          exit 1
        fi
        
        echo "=== Basedpyright output (first 50 lines) ==="
        head -50 /tmp/basedpyright_output.txt
        echo ""
        
        # Change to repo root for path normalization
        cd "$REPO_ROOT"
        
        # Filter out non-error lines (basedpyright outputs summary info)
        # Keep only lines that look like errors: file:line:column - severity: message
        # Format: /path/to/file.py:18:18 - warning: message (may have leading spaces)
        grep -E "^[[:space:]]*[^:]+:[0-9]+:[0-9]+ - " /tmp/basedpyright_output.txt | \
          sed 's/^[[:space:]]*//' | \
          sed "s|^$REPO_ROOT/||" > /tmp/basedpyright_errors.txt || true
        
        echo "=== Filtered errors (first 20 lines) ==="
        head -20 /tmp/basedpyright_errors.txt || echo "No errors found"
        echo ""
        echo "=== Total error lines ==="
        wc -l /tmp/basedpyright_errors.txt || echo "0"
        echo ""
        
        # Check if there are any errors
        if [ ! -s /tmp/basedpyright_errors.txt ]; then
          echo "No new type errors found (baseline may have filtered them out, or no errors exist)"
          exit 0
        fi
        
        # Run reviewdog with the filtered errors
        # Basedpyright outputs: file:line:column - severity: message
        # Error format: %f = file, %l = line, %c = column, %m = message
        # We need to match: file:line:column - severity: message
        # The pattern "%f:%l:%c - %t: %m" doesn't work, so we'll use "%f:%l:%c - %m" 
        # which will include "severity: message" in %m
        echo "=== Running reviewdog ==="
        cat /tmp/basedpyright_errors.txt | \
          /tmp/reviewdog \
            -efm="%f:%l:%c - %m" \
            -reporter=github-pr-review \
            -fail-on-error=false \
            -filter-mode=diff_context \
            -diff="git diff origin/${{ github.base_ref }}" \
            -tee || true
        
        echo "=== Reviewdog completed ==="

