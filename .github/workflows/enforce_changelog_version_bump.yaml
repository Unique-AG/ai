name: "[chore] Enforce Changelog and Version Bump"

on:
  pull_request:
    paths:
      - 'unique_sdk/**'
      - '!unique_sdk/**/docs/**'
      - '!unique_sdk/**/mkdocs.yaml'
      - 'unique_toolkit/**'
      - '!unique_toolkit/**/docs/**'
      - '!unique_toolkit/**/mkdocs.yaml'
      - '!unique_toolkit/.entangled/**'
      - 'unique_orchestrator/**'
      - 'connectors/unique_quartr/**'
      - 'connectors/unique_search_proxy/web/**'
      - 'postprocessors/unique_follow_up_questions/**'
      - 'postprocessors/unique_stock_ticker/**'
      - 'tool_packages/unique_deep_research/**'
      - 'tool_packages/unique_internal_search/**'
      - 'tool_packages/unique_swot/**'
      - 'tool_packages/unique_web_search/**'

jobs:
  detect-packages:
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.set-packages.outputs.packages }}
      packages_json: ${{ steps.set-packages.outputs.packages_json }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for proper diff

      - name: Get changed files
        id: changed-files
        run: |
          if [ "${{ github.event.pull_request.base.sha }}" != "" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
          else
            BASE_SHA=$(git merge-base HEAD origin/${{ github.base_ref }})
          fi
          
          echo "BASE_SHA=$BASE_SHA" >> $GITHUB_ENV
          echo "HEAD_SHA=${{ github.event.pull_request.head.sha || github.sha }}" >> $GITHUB_ENV
          
          # Get list of changed files
          git diff --name-only $BASE_SHA $HEAD_SHA > changed_files.txt
          echo "Changed files:"
          cat changed_files.txt

      - name: Extract package names
        id: set-packages
        run: |
          ./.github/scripts/detect-changed-packages.sh changed_files.txt

      - name: Display detected packages
        run: |
          echo "Changed packages: ${{ steps.set-packages.outputs.packages }}"
          echo "Changed packages (JSON): ${{ steps.set-packages.outputs.packages_json }}"

  validate-changes:
    needs: detect-packages
    if: needs.detect-packages.outputs.packages != ''
    runs-on: ubuntu-latest

    strategy:
      matrix:
        package: ${{ fromJson(needs.detect-packages.outputs.packages_json) }}

    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if package has changes
        id: changes
        run: |
          git fetch origin ${{ github.base_ref }}
          MERGE_BASE=$(git merge-base HEAD origin/${{ github.base_ref }})

          # List changed files in the package, excluding docs/config
          CHANGED_FILES=$(
            git diff --name-only "$MERGE_BASE..HEAD" \
              | grep "^${{ matrix.package }}/" \
              | grep -vE "^${{ matrix.package }}/(docs/|mkdocs\.yaml|\.entangled/)" \
              || true
          )
          if [ -n "$CHANGED_FILES" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Validate changelog and version bump
        if: steps.changes.outputs.changed == 'true'
        run: ./.github/scripts/validate-changelog-version-bump.sh ${{ matrix.package }} ${{ github.base_ref }}
