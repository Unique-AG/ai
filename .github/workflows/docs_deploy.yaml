# Deploy root site (nav + Tutorials) to gh-pages root, then mike-deploy SDK and Toolkit
# to unique-sdk/ and unique-toolkit/ with their own version dropdowns.

name: "[docs] Deploy documentation"

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

on:
  workflow_dispatch:
  push:
    branches:
      - main
    tags:
      - 'docs-v*'
      - 'sdk-v*'
      - 'toolkit-v*'
    paths:
      - docs/**
      - mkdocs.yaml
      - pyproject.toml
      - unique_sdk/docs/**
      - unique_sdk/mkdocs.yaml
      - unique_sdk/pyproject.toml
      - unique_toolkit/docs/**
      - unique_toolkit/mkdocs.yaml
      - unique_toolkit/pyproject.toml
      - tutorials/docs/**
      - tutorials/mkdocs.yaml
      - .github/workflows/docs_deploy.yaml

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python and Poetry
        uses: ./.github/actions/setup-python-poetry

      - name: Install dependencies
        run: poetry install --with dev

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # 1) Build root site (Home, Guidelines, nav links to SDK/Toolkit, Tutorials)
      - name: Build root documentation
        run: poetry run mkdocs build

      # 2) Deploy root to gh-pages (merge into branch root; keep existing unique-sdk/ and unique-toolkit/)
      - name: Fetch gh-pages
        run: git fetch origin gh-pages --depth=1 || true

      - name: Deploy root to gh-pages
        run: |
          cp -r site /tmp/root_site
          git checkout gh-pages 2>/dev/null || git checkout --orphan gh-pages
          git reset --hard origin/gh-pages 2>/dev/null || true
          rsync -av --exclude='.git' /tmp/root_site/ .
          git add -A
          git diff --staged --quiet || git commit -m "docs: deploy root and tutorials"
          git push origin gh-pages
          git checkout -

      # 3) Mike deploy SDK to unique-sdk/ (deploy_prefix in unique_sdk/mkdocs.yaml)
      - name: Get SDK version
        id: sdk_version
        working-directory: unique_sdk
        run: |
          VERSION=$(poetry version -s)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Deploy SDK with mike (dev)
        if: github.ref == 'refs/heads/main'
        run: |
          poetry run mike deploy -F unique_sdk/mkdocs.yaml --push --update-aliases ${{ steps.sdk_version.outputs.version }} dev
          poetry run mike set-default -F unique_sdk/mkdocs.yaml --push dev

      - name: Deploy SDK with mike (release)
        if: startsWith(github.ref, 'refs/tags/sdk-v')
        run: |
          poetry run mike deploy -F unique_sdk/mkdocs.yaml --push --update-aliases ${{ steps.sdk_version.outputs.version }} latest
          poetry run mike set-default -F unique_sdk/mkdocs.yaml --push latest

      # 4) Mike deploy Toolkit to unique-toolkit/
      - name: Get Toolkit version
        id: toolkit_version
        working-directory: unique_toolkit
        run: |
          VERSION=$(poetry version -s)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Deploy Toolkit with mike (dev)
        if: github.ref == 'refs/heads/main'
        run: |
          poetry run mike deploy -F unique_toolkit/mkdocs.yaml --push --update-aliases ${{ steps.toolkit_version.outputs.version }} dev
          poetry run mike set-default -F unique_toolkit/mkdocs.yaml --push dev

      - name: Deploy Toolkit with mike (release)
        if: startsWith(github.ref, 'refs/tags/toolkit-v')
        run: |
          poetry run mike deploy -F unique_toolkit/mkdocs.yaml --push --update-aliases ${{ steps.toolkit_version.outputs.version }} latest
          poetry run mike set-default -F unique_toolkit/mkdocs.yaml --push latest