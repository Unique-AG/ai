name: "[dependency-check] Unique MCP"

env:
  PACKAGE: unique_mcp

on: 
  pull_request:
    paths:
      - 'unique_mcp/**'

jobs:
  dependency-check:
    runs-on: ubuntu-latest
    continue-on-error: true
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for diff comparison

      - name: Install reviewdog
        run: |
          curl -sfL https://raw.githubusercontent.com/reviewdog/reviewdog/master/install.sh | sh -s -- -b /tmp

      - name: Fetch base branch for comparison
        run: git fetch origin ${{ github.base_ref }}:${{ github.base_ref }}

      - name: Install package manager
        id: install_pm
        uses: ./.github/actions/install-package-manager
        with:
          package_dir: ${{ env.PACKAGE }}
          package_manager: 'auto'
          python_version: '3.12'

      - name: Create worktree for base branch
        run: |
          git worktree add /tmp/base-tree ${{ github.base_ref }}

      - name: Install dependencies (base branch)
        working-directory: /tmp/base-tree/${{ env.PACKAGE }}
        run: ${{ steps.install_pm.outputs.install_cmd }}

      - name: Run deptry on base branch
        continue-on-error: true
        working-directory: /tmp/base-tree/${{ env.PACKAGE }}
        run: |
          bash ${{ github.workspace }}/.github/scripts/run-deptry.sh \
            -r "${{ steps.install_pm.outputs.run_cmd }}" \
            -o /tmp/deptry-base.json \
            /tmp/base-tree/${{ env.PACKAGE }} || true

      - name: Install dependencies (current branch)
        working-directory: ${{ env.PACKAGE }}
        run: ${{ steps.install_pm.outputs.install_cmd }}

      - name: Run deptry on current branch
        continue-on-error: true
        working-directory: ${{ env.PACKAGE }}
        run: |
          bash ${{ github.workspace }}/.github/scripts/run-deptry.sh \
            -r "${{ steps.install_pm.outputs.run_cmd }}" \
            -o /tmp/deptry-current.json \
            ${{ github.workspace }}/${{ env.PACKAGE }} || true

      - name: Cleanup worktree
        if: always()
        run: git worktree remove /tmp/base-tree || true

      - name: Compare dependency issues
        continue-on-error: true
        run: |
          bash ${{ github.workspace }}/.github/scripts/compare-dependency-issues.sh \
            -o /tmp/deptry-comparison.json \
            ${{ github.workspace }}/${{ env.PACKAGE }} \
            /tmp/deptry-base.json \
            /tmp/deptry-current.json || true

      - name: Report dependency errors
        continue-on-error: true
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          bash ${{ github.workspace }}/.github/scripts/report-dependency-errors.sh \
            -r /tmp/reviewdog \
            -b ${{ github.base_ref }} \
            ${{ github.workspace }}/${{ env.PACKAGE }} \
            /tmp/deptry-comparison.json || true

