name: "[type-check] Unique MCP"

env:
  PACKAGE: unique_mcp

on: 
  pull_request:
    paths:
      - 'unique_mcp/**'

jobs:
  type-check:
    runs-on: ubuntu-latest
    continue-on-error: true
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for diff comparison

      - name: Install reviewdog
        run: |
          curl -sfL https://raw.githubusercontent.com/reviewdog/reviewdog/master/install.sh | sh -s -- -b /tmp

      - name: Fetch base branch for comparison
        run: git fetch origin ${{ github.base_ref }}:${{ github.base_ref }}

      - name: Create baseline from base branch
        uses: ./.github/actions/create-type-baseline
        with:
          package_dir: ${{ env.PACKAGE }}
          branch: ${{ github.base_ref }}
          package_manager: 'auto'
          python_version: '3.12'

      - name: Run type check
        uses: ./.github/actions/type-check
        with:
          package_dir: ${{ env.PACKAGE }}
          package_manager: 'auto'
          python_version: '3.12'
          baseline_file: /tmp/baseline.json
          output_file: /tmp/basedpyright.json

      - name: Report type errors
        continue-on-error: true
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          bash ${{ github.workspace }}/.github/scripts/report-type-errors.sh \
            -r /tmp/reviewdog \
            -b ${{ github.base_ref }} \
            ${{ github.workspace }}/${{ env.PACKAGE }} \
            /tmp/basedpyright.json || true

